<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Minijogos</title>
    <style>
        /* ⭐️ INÍCIO DA SEÇÃO DE ESTILO HERDADA ⭐️ */
        :root {
            --primary-text-color: #1a2533;
            --secondary-text-color: #6c757d;
            --page-bg-color: #f4f7f9;
            --card-bg-color: rgba(255, 255, 255, 0.92);
            --card-shadow-color: rgba(0, 0, 0, 0.1);
            --accent-color: #007bff;
            --bg-image: none;
            --bg-opacity: 1;
        }
        body.dark-theme {
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #b0b0b0;
            --page-bg-color: #121212;
            --card-bg-color: rgba(40, 40, 40, 0.92);
            --card-shadow-color: rgba(0, 0, 0, 0.4);
            --accent-color: #4dabf7;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--page-bg-color); color: var(--primary-text-color); 
            margin: 0; padding: 0; position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1; background-image: var(--bg-image); background-size: cover;
            background-position: center; background-repeat: no-repeat;
            opacity: var(--bg-opacity); transition: opacity 0.3s ease, background-image 0.5s ease-in-out;
        }
        /* ⭐️ FIM DA SEÇÃO DE ESTILO HERDADA ⭐️ */

        .container { max-width: 1800px; margin: 0 auto; padding: 20px; padding-top: 90px; }
        .main-header { 
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; 
            background-color: var(--card-bg-color); box-shadow: 0 2px 4px var(--card-shadow-color);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000; 
            flex-wrap: wrap; gap: 10px;
        }
        .header-left-group, .header-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .main-header h1, .main-header h2 { margin: 0; }
        .main-header h1 { font-size: 1.5em; }
        #project-name { font-size: 1.1em; color: var(--secondary-text-color); font-weight: normal; }
        .separator { color: #ccc; font-size: 1.5em; }
        .header-actions .btn { padding: 8px 15px; }
        #bulk-actions-container { display: none; }
        #bulk-actions-container.visible { display: flex; align-items: center; gap: 10px; }
        .btn { border-radius: 4px; border: none; font-weight: bold; cursor: pointer; transition: background-color 0.2s; color: white; text-align: center; text-decoration: none; display: inline-flex; justify-content: center; align-items: center; padding: 6px 12px; font-size: 14px; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-success { background-color: #28a745; }
        .btn-primary { background-color: var(--accent-color); }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        #back-btn { width: 40px; height: 40px; padding: 0; border-radius: 50%; }
        #back-btn svg { width: 22px; height: 22px; }

        .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-overlay.visible { display: flex; }
        .modal-content { 
            background-color: var(--card-bg-color); color: var(--primary-text-color);
            padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px var(--card-shadow-color); 
            width: 90%; max-width: 850px; position: relative; max-height: 90vh; overflow-y: auto; 
        }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .form { display: flex; flex-direction: column; gap: 10px; }
        .form label { font-weight: bold; margin-top: 5px; }
        .form input, .form textarea, .form select { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; background-color: var(--page-bg-color); color: var(--primary-text-color); }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        .file-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        #search-input { width: 250px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 800px; }
        #table-container { background-color: var(--card-bg-color); border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow-color); overflow-x: auto; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: middle; word-wrap: break-word; }
        th { background-color: var(--accent-color); color: white; font-weight: bold; user-select: none; position: relative; }
        th[data-column] { cursor: pointer; }
        th[data-column]::after { content: ' \2195'; opacity: 0.4; }
        th[data-column].sorted-asc::after { content: ' \2191'; opacity: 1; }
        th[data-column].sorted-desc::after { content: ' \2193'; opacity: 1; }
        th.no-sort { cursor: default; }
        tr.selected-row > td { background-color: #fff3cd !important; }
        tr:hover > td { background-color: rgba(128, 128, 128, 0.1); }
        
        .table-thumb { max-width: 80px; max-height: 45px; border-radius: 4px; object-fit: cover; background-color: #eee; }
        
        fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 15px; margin: 15px 0; }
        legend { font-weight: bold; padding: 0 10px; color: var(--accent-color); font-size: 1.1em;}
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-grid-full { grid-column: 1 / -1; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

        .curiosity-entry { border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-top: 10px; display: grid; grid-template-columns: 1fr 200px; gap: 15px; align-items: flex-start; }
        .curiosity-text-area { display: flex; flex-direction: column; }
        .curiosity-char-counter { text-align: right; font-size: 0.8em; color: var(--secondary-text-color); margin-top: 5px; }
        .curiosity-image-area { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .curiosity-preview { width: 100%; max-width: 200px; height: 112px; border: 2px dashed #ccc; border-radius: 4px; object-fit: cover; background-color: #f8f9fa; display: flex; justify-content: center; align-items: center; color: var(--secondary-text-color); font-size: 0.9em; }

        @media (max-width: 1024px) {
            .main-header { justify-content: center; }
            .header-left-group, .header-actions { width: 100%; justify-content: center; }
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; padding-top: 220px; }
            .main-header { justify-content: flex-start; flex-direction: column; align-items: flex-start; }
            .header-left-group, .header-actions { flex-direction: column; align-items: stretch; width: 100%; }
            #search-input { width: 100%; }
            .separator { display: none; }
            .btn { width: 100%; }
            #back-btn { width: 40px; height: 40px; align-self: flex-start; }
            .form-grid, .curiosity-entry { grid-template-columns: 1fr; }
            .curiosity-image-area { margin-top: 10px; }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-left-group">
            <a href="index.html" id="back-btn" class="btn btn-secondary" title="Voltar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></a>
            <span class="separator">|</span>
            <h1>Minigames</h1>
            <span class="separator">|</span>
            <h2 id="project-name"></h2>
            <span class="separator">|</span>
            <input type="text" id="search-input" placeholder="Pesquisar na tabela...">
        </div>
        <div class="header-actions">
            <div id="bulk-actions-container"><button id="delete-selected-btn" class="btn btn-danger">Excluir</button><span class="separator">|</span></div>
            <button id="export-table-btn" class="btn btn-primary">Exportar Tabela</button>
            <button id="show-add-item-modal-btn" class="btn btn-success">Adicionar Item</button>
            <span class="separator">|</span>
            <div class="file-input-wrapper"><button class="btn btn-secondary">Importar</button><input type="file" id="import-json-input" accept=".json"></div>
            <button id="export-json-btn" class="btn btn-primary">Salvar Projeto</button>
        </div>
    </header>

    <div class="container">
        <div id="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 5%;" data-column="#">#</th>
                        <th style="width: 10%;" class="no-sort">Thumb</th>
                        <th style="width: 20%;" data-column="Nome">Nome</th>
                        <th style="width: 20%;" data-column="Inspiração">Inspiração</th>
                        <th style="width: 15%;" data-column="Local">Local</th>
                        <th style="width: 15%;" class="no-sort">Referências</th>
                        <th style="width: 10%;" class="no-sort">Ver Mais</th>
                        <th style="width: 5%; text-align: center;" class="no-sort"><input type="checkbox" id="select-all-checkbox" title="Selecionar Todos"></th>
                    </tr>
                </thead>
                <tbody id="minigames-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="details-modal" class="modal-overlay"></div>

    <!-- MUDANÇA: Scripts do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // ===================================================================
    //  BLOCO DE CONFIGURAÇÃO E LÓGICA DO FIREBASE
    // ===================================================================
    
    // **SUA AÇÃO NECESSÁRIA:** COLE A SUA CONFIGURAÇÃO DO FIREBASE AQUI
    const firebaseConfig = {
        apiKey: "AIzaSyC9OjBDOX9UUlCrPuhIZj5ipolRT4Gu420",
        authDomain: "gerenciadorcentral-f01e3.firebaseapp.com",
        projectId: "gerenciadorcentral-f01e3",
        storageBucket: "gerenciadorcentral-f01e3.appspot.com",
        messagingSenderId: "8874050225",
        appId: "1:8874050225:web:a536c7feb14f36af7cd890"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const minigamesDocRef = db.collection('settings').doc('minigames-data');
    const styleDocRef = db.collection('settings').doc('main-dashboard');

    // Variáveis de estado globais
    let minigameData = [];
    let projectName = "Carregando...";
    let selectedItems = new Set();
    let currentSort = {};
    let initialDataState = '';
    let isSaving = false; // Flag para evitar salvamentos múltiplos

    // MUDANÇA: Salva o estado atual no Firestore
    const saveDataToFirebase = () => {
        if (isSaving) return; // Evita loop de salvamento
        isSaving = true;
        const dataToSave = { projectName, games: minigameData };
        minigamesDocRef.set(dataToSave)
            .then(() => {
                console.log("Dados dos minigames salvos no Firebase.");
                initialDataState = JSON.stringify(minigameData);
            })
            .catch(error => console.error("Erro ao salvar no Firebase:", error))
            .finally(() => { isSaving = false; });
    };

    // MUDANÇA: Carrega dados em tempo real do Firestore
    const loadDataFromFirebase = () => {
        minigamesDocRef.onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                minigameData = data.games || [];
                projectName = data.projectName || "Projeto sem nome";
                console.log("Dados dos minigames carregados do Firebase.");
            } else {
                minigameData = [];
                projectName = "Novo Projeto de Minigames";
                console.log("Nenhum dado encontrado, iniciando novo projeto.");
            }
            initialDataState = JSON.stringify(minigameData);
            updateAndRender();
        }, error => {
            console.error("Erro ao carregar do Firebase:", error);
            projectName = "Falha na conexão";
            updateHeader();
        });
    };
    
    // MUDANÇA: Carrega estilos globais do Firebase
    async function loadAndApplyGlobalStyle() {
        try {
            const doc = await styleDocRef.get();
            if (doc.exists && doc.data().styleData) {
                const style = doc.data().styleData;
                const body = document.body;
                const root = document.documentElement;
                body.className = '';
                body.classList.add(style.theme || 'light-theme');
                body.style.backgroundColor = style.bgColor;
                root.style.setProperty('--bg-image', style.bgImage ? `url('${style.bgImage}')` : 'none');
                root.style.setProperty('--bg-opacity', style.bgOpacity || '1');
            }
        } catch (e) {
            console.error("Não foi possível carregar os estilos do Firebase.", e);
        }
    }

    // ===================================================================
    //  FIM DO BLOCO FIREBASE. O RESTO DO CÓDIGO USA AS NOVAS FUNÇÕES.
    // ===================================================================

    const hasUnsavedChanges = () => JSON.stringify(minigameData) !== initialDataState;
    const updateHeader = () => { document.getElementById('project-name').textContent = projectName; };

    const renderTable = (dataToRender) => {
        const tableBody = document.getElementById('minigames-tbody');
        tableBody.innerHTML = '';
        const placeholderThumb = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='45' viewBox='0 0 80 45'%3E%3Crect width='80' height='45' fill='%23e9ecef'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%236c757d' font-family='sans-serif' font-size='10px'%3EN/A%3C/text%3E%3C/svg%3E";

        dataToRender.forEach((item, index) => {
            const originalIndex = minigameData.findIndex(originalItem => originalItem === item);
            if (originalIndex === -1) return;

            const row = document.createElement('tr');
            if (selectedItems.has(originalIndex)) row.classList.add('selected-row');
            
            const referencesHTML = (item['Referências'] || []).map(ref => `<div><a href="${ref.url || '#'}" target="_blank">${ref.nome || 'Link'}</a></div>`).join('');
            
            row.innerHTML = `
                <td>${item['#'] || ''}</td>
                <td><img src="${item.Thumb || placeholderThumb}" alt="Thumb" class="table-thumb"></td>
                <td>${item['Nome'] || ''}</td>
                <td>${item['Inspiração'] || ''}</td>
                <td>${item['Local'] || ''}</td>
                <td>${referencesHTML || 'N/A'}</td>
                <td style="text-align: center;"><button class="btn btn-primary open-details-btn" data-index="${originalIndex}">Ver Mais</button></td>
                <td style="text-align: center;"><input type="checkbox" class="select-checkbox" data-index="${originalIndex}" ${selectedItems.has(originalIndex) ? 'checked' : ''}></td>`;
            tableBody.appendChild(row);
        });
    };
    
    const filterAndRender = () => {
        const filterText = document.getElementById('search-input').value.toLowerCase();
        const filteredData = filterText 
            ? minigameData.filter(item => ['#', 'Nome', 'Inspiração', 'Local'].some(key => String(item[key] || '').toLowerCase().includes(filterText)))
            : minigameData;
        renderTable(filteredData);
    };

    const updateAndRender = (doSave = false) => {
        updateHeader();
        filterAndRender();
        if(doSave) {
            saveDataToFirebase();
        }
    };
    
    // --- Lógica do Modal ---
    const setupDetailsModal = () => {
        const modalHTML = `
            <div class="modal-content">
                <span class="modal-close">×</span>
                <h2 id="details-modal-title">Detalhes do Item</h2>
                <form id="details-form" class="form">
                    <input type="hidden" id="details-item-index">
                    <fieldset><legend>Informações Básicas</legend>
                        <div class="form-grid">
                            <div><label for="details-num">#:</label><input type="number" id="details-num" step="any"></div>
                            <div><label for="details-nome">Nome:</label><input type="text" id="details-nome" required></div>
                            <div class="form-grid-full"><label for="details-inspiracao">Inspiração:</label><input type="text" id="details-inspiracao"></div>
                            <div class="form-grid-full"><label for="details-descricao">Descrição:</label><textarea id="details-descricao" rows="4"></textarea></div>
                            <div><label for="details-local">Local:</label><input type="text" id="details-local"></div>
                            <div><label for="details-map-path">Nome do Arquivo do Mapa:</label><input type="text" id="details-map-path"></div>
                        </div>
                    </fieldset>
                    <fieldset><legend>Guia Visual e Textual</legend>
                        <div class="form-grid">
                            <div><label>Thumb (Imagem):</label><div class="file-controls"><input type="file" id="details-thumb-input" accept="image/*" style="display:none;"><button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('details-thumb-input').click();">Escolher</button><button type="button" class="btn btn-danger btn-sm remove-file-btn" data-input-id="details-thumb-input" data-filename-id="details-thumb-filename" data-default-text="Nenhuma imagem.">Remover</button><span id="details-thumb-filename">Nenhuma imagem.</span></div></div>
                            <div><label>Vídeo Guia:</label><div class="file-controls"><input type="file" id="details-video-input" accept="video/*" style="display:none;"><button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('details-video-input').click();">Escolher</button><button type="button" class="btn btn-danger btn-sm remove-file-btn" data-input-id="details-video-input" data-filename-id="details-video-filename" data-default-text="Nenhum vídeo.">Remover</button><span id="details-video-filename">Nenhum vídeo.</span></div></div>
                            <div class="form-grid-full"><label for="details-titulo-guia">Título Guia (max 20):</label><input type="text" id="details-titulo-guia" maxlength="20"></div>
                            <div class="form-grid-full"><label for="details-texto-guia">Texto Guia (max 110):</label><textarea id="details-texto-guia" rows="3" maxlength="110"></textarea></div>
                        </div>
                    </fieldset>
                    <fieldset><legend>Controles Opcionais</legend>
                        <div class="checkbox-group"><input type="checkbox" id="details-usa-stick" style="width:auto;"><label for="details-usa-stick">Usa Stick?</label><input type="text" id="details-texto-stick" placeholder="Texto Stick (max 20)" maxlength="20"></div>
                        <div class="checkbox-group"><input type="checkbox" id="details-usa-btn1" style="width:auto;"><label for="details-usa-btn1">Usa Botão Primário?</label><input type="text" id="details-texto-btn1" placeholder="Texto Botão (max 20)" maxlength="20"></div>
                        <div class="checkbox-group"><input type="checkbox" id="details-usa-btn2" style="width:auto;"><label for="details-usa-btn2">Usa Botão Secundário?</label><input type="text" id="details-texto-btn2" placeholder="Texto Botão (max 20)" maxlength="20"></div>
                    </fieldset>
                    <fieldset><legend>Curiosidades</legend>
                        <div id="curiosities-container"></div>
                        <button type="button" id="add-curiosity-btn" class="btn btn-secondary" style="margin-top: 10px;">Adicionar Curiosidade</button>
                    </fieldset>
                    <button type="submit" class="btn btn-success" style="width:100%; padding: 15px; font-size: 1.2em;">Salvar Alterações</button>
                </form>
            </div>`;
        document.getElementById('details-modal').innerHTML = modalHTML;
    };
    
    const addCuriosityRow = (container, data = {}) => {
        const uniqueId = `curiosity-file-${Date.now()}-${Math.random()}`;
        const entry = document.createElement('div');
        entry.className = 'curiosity-entry';
        
        entry.innerHTML = `<div class="curiosity-text-area"><textarea class="curiosity-text" placeholder="Texto da curiosidade (max 250)" maxlength="250">${data.texto || ''}</textarea><div class="curiosity-char-counter">0 / 250</div></div><div class="curiosity-image-area"><img src="${data.foto || ''}" class="curiosity-preview" alt="Preview"><input type="file" id="${uniqueId}" class="curiosity-image-input" accept="image/*" style="display:none;"><button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('${uniqueId}').click();">Escolher Imagem</button><button type="button" class="btn btn-danger btn-sm remove-curiosity-btn">Remover</button></div>`;

        const textarea = entry.querySelector('.curiosity-text');
        const charCounter = entry.querySelector('.curiosity-char-counter');
        const updateCounter = () => { charCounter.textContent = `${textarea.value.length} / 250`; };
        textarea.addEventListener('input', updateCounter);
        updateCounter();

        entry.querySelector('.curiosity-image-input').addEventListener('change', function(e) { if (e.target.files[0]) { const reader = new FileReader(); reader.onload = (event) => { entry.querySelector('.curiosity-preview').src = event.target.result; }; reader.readAsDataURL(e.target.files[0]); } });
        entry.querySelector('.remove-curiosity-btn').addEventListener('click', () => entry.remove());
        container.appendChild(entry);
    };
    
    const openDetailsModal = (mode, itemIndex = null) => {
        const form = document.getElementById('details-form'); form.reset();
        document.getElementById('details-thumb-filename').textContent = 'Nenhuma imagem.'; document.getElementById('details-video-filename').textContent = 'Nenhum vídeo.';
        
        if (mode === 'edit' && itemIndex !== null) {
            const item = minigameData[itemIndex];
            document.getElementById('details-modal-title').textContent = `#${item['#'] || '?'} - ${item['Nome'] || 'Item sem nome'}`;
            document.getElementById('details-item-index').value = itemIndex;
            Object.keys(item).forEach(key => {
                const elementId = `details-${key.toLowerCase().replace(/ /g, '-').replace('á', 'a').replace('ç', 'c')}`;
                const element = document.getElementById(elementId);
                if (element) { if(element.type === 'checkbox') element.checked = item[key]; else element.value = item[key] || ''; }
            });
            document.getElementById('details-thumb-filename').textContent = item.ThumbFilename || 'Nenhuma imagem.';
            document.getElementById('details-video-filename').textContent = item.VideoGuiaFilename || 'Nenhum vídeo.';
            const curiositiesContainer = document.getElementById('curiosities-container');
            curiositiesContainer.innerHTML = '';
            (item.Curiosidades || []).forEach(curiosity => addCuriosityRow(curiositiesContainer, curiosity));
        } else {
            document.getElementById('details-modal-title').textContent = 'Adicionar Novo Item';
            document.getElementById('details-item-index').value = '';
            document.getElementById('curiosities-container').innerHTML = '';
        }
        document.getElementById('details-modal').classList.add('visible');
    };

    const saveDetailsForm = (e) => {
        e.preventDefault();
        const itemIndex = document.getElementById('details-item-index').value;
        const isNewItem = itemIndex === '';
        let item = isNewItem ? { 'Referências': [] } : minigameData[itemIndex];

        // Mapeia todos os campos do formulário para o objeto item
        item['#'] = parseFloat(document.getElementById('details-num').value) || null;
        item['Nome'] = document.getElementById('details-nome').value;
        item['Inspiração'] = document.getElementById('details-inspiracao').value;
        item['Descrição'] = document.getElementById('details-descricao').value;
        item['Local'] = document.getElementById('details-local').value;
        item['Nome do Arquivo do mapa'] = document.getElementById('details-map-path').value;
        item['Título Guia'] = document.getElementById('details-titulo-guia').value;
        item['Texto Guia'] = document.getElementById('details-texto-guia').value;
        item['Usa Stick'] = document.getElementById('details-usa-stick').checked;
        item['Texto Stick'] = document.getElementById('details-texto-stick').value;
        item['Usa Botão Primário'] = document.getElementById('details-usa-btn1').checked;
        item['Texto Botão Primário'] = document.getElementById('details-texto-btn1').value;
        item['Usa Botão Secundário'] = document.getElementById('details-usa-btn2').checked;
        item['Texto Botão Secundário'] = document.getElementById('details-texto-btn2').value;

        if (document.getElementById('details-video-input').files[0]) item.VideoGuiaFilename = document.getElementById('details-video-input').files[0].name;
        else if (document.getElementById('details-video-filename').textContent === 'Nenhum vídeo.') item.VideoGuiaFilename = '';
        
        item.Curiosidades = Array.from(document.querySelectorAll('#curiosities-container .curiosity-entry')).map(entry => ({ texto: entry.querySelector('.curiosity-text').value, foto: entry.querySelector('.curiosity-preview').src }));

        const onThumbProcessed = () => {
            if (isNewItem) minigameData.push(item);
            updateAndRender(true);
            document.getElementById('details-modal').classList.remove('visible');
        };
        
        const thumbFileInput = document.getElementById('details-thumb-input');
        if (thumbFileInput.files[0]) {
            const thumbFile = thumbFileInput.files[0];
            item.ThumbFilename = thumbFile.name;
            const reader = new FileReader();
            reader.onload = (event) => { item.Thumb = event.target.result; onThumbProcessed(); };
            reader.readAsDataURL(thumbFile);
        } else {
            if (document.getElementById('details-thumb-filename').textContent === 'Nenhuma imagem.') { item.Thumb = ''; item.ThumbFilename = ''; }
            onThumbProcessed();
        }
    };
    
    // --- Lógica de Exportação e Eventos ---
    const exportTableData = () => {
        if (minigameData.length === 0) { alert("Não há dados para exportar."); return; }
        const maxCuriosities = Math.max(0, ...minigameData.map(item => (item.Curiosidades || []).length));
        const baseHeaders = ["id", "name", "thumb", "local", "path", "guide_text_title", "guide_text", "use_stick", "text_stick", "use_primary", "text_primary", "use_secondary", "text_secondary", "guide_video"];
        for (let i = 1; i <= maxCuriosities; i++) baseHeaders.push(`CURIOSITY_${i}`);
        const header = baseHeaders.join('\t');
        const rows = minigameData.map(item => {
            const rowData = [item['#'] || '', item['Nome'] || '', item['ThumbFilename'] || '', item['Local'] || '', item['Nome do Arquivo do mapa'] || '', item['Título Guia'] || '', item['Texto Guia'] || '', item['Usa Stick'] ? 'TRUE' : 'FALSE', item['Texto Stick'] || '', item['Usa Botão Primário'] ? 'TRUE' : 'FALSE', item['Texto Botão Primário'] || '', item['Usa Botão Secundário'] ? 'TRUE' : 'FALSE', item['Texto Botão Secundário'] || '', item['VideoGuiaFilename'] || ''];
            for (let i = 0; i < maxCuriosities; i++) { rowData.push(((item.Curiosidades || [])[i]?.texto || '').replace(/\s+/g, ' ')); }
            return rowData.join('\t');
        }).join('\n');
        const blob = new Blob([`\uFEFF${`${header}\n${rows}`}`], { type: 'text/tab-separated-values;charset=utf-8;' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `${projectName.replace(/ /g, "_") || 'tabela'}.tsv`; a.click(); URL.revokeObjectURL(a.href);
    };

    document.getElementById('search-input').addEventListener('keyup', filterAndRender);
    document.getElementById('export-table-btn').addEventListener('click', exportTableData);
    document.getElementById('show-add-item-modal-btn').addEventListener('click', () => openDetailsModal('add'));

    document.getElementById('table-container').addEventListener('click', (e) => {
        if (e.target.classList.contains('open-details-btn')) openDetailsModal('edit', e.target.dataset.index);
        if (e.target.classList.contains('select-checkbox')) {
            const index = parseInt(e.target.dataset.index, 10);
            const row = e.target.closest('tr');
            if (e.target.checked) { selectedItems.add(index); row.classList.add('selected-row'); } 
            else { selectedItems.delete(index); row.classList.remove('selected-row'); }
            document.getElementById('bulk-actions-container').classList.toggle('visible', selectedItems.size > 0);
        }
    });

    document.getElementById('details-modal').addEventListener('click', (e) => {
        if (e.target.id === 'add-curiosity-btn') addCuriosityRow(document.getElementById('curiosities-container'));
        if (e.target.classList.contains('remove-file-btn')) { document.getElementById(e.target.dataset.inputId).value = ''; document.getElementById(e.target.dataset.filenameId).textContent = e.target.dataset.defaultText; }
        if(e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close')) e.currentTarget.classList.remove('visible');
    });

    document.getElementById('details-form').addEventListener('submit', saveDetailsForm);
    document.getElementById('details-modal').addEventListener('change', (e) => { if (e.target.type === 'file') { document.getElementById(`${e.target.id.replace('-input', '')}-filename`).textContent = e.target.files.length > 0 ? e.target.files[0].name : (e.target.id.includes('thumb') ? "Nenhuma imagem." : "Nenhum vídeo."); } });

    document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
        const isChecked = e.target.checked; selectedItems.clear();
        document.querySelectorAll('#minigames-tbody .select-checkbox').forEach(checkbox => { checkbox.checked = isChecked; if (isChecked) selectedItems.add(parseInt(checkbox.dataset.index, 10)); checkbox.closest('tr').classList.toggle('selected-row', isChecked); });
        document.getElementById('bulk-actions-container').classList.toggle('visible', selectedItems.size > 0);
    });

    document.getElementById('delete-selected-btn').addEventListener('click', () => {
        if (selectedItems.size === 0 || !confirm(`Tem certeza que deseja excluir ${selectedItems.size} item(ns)?`)) return;
        const sortedIndexes = Array.from(selectedItems).sort((a, b) => b - a);
        sortedIndexes.forEach(index => minigameData.splice(index, 1));
        selectedItems.clear(); document.getElementById('select-all-checkbox').checked = false; document.getElementById('bulk-actions-container').classList.remove('visible');
        updateAndRender(true);
    });

    document.getElementById('export-json-btn').addEventListener('click', () => {
        if(minigameData.length === 0){ alert("Não há dados para exportar."); return; }
        const dataStr = JSON.stringify({ projectName, games: minigameData }, null, 2);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([dataStr], { type: 'application/json' }));
        a.download = `${projectName.replace(/ /g, "_") || 'minigames_projeto'}.json`; a.click(); URL.revokeObjectURL(a.href);
    });

    document.getElementById('import-json-input').addEventListener('change', (e) => {
        if (hasUnsavedChanges() && !confirm("Você tem alterações não salvas. Deseja importar e perder as alterações atuais?")) { e.target.value = ''; return; }
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (importedData && Array.isArray(importedData.games)) {
                    projectName = importedData.projectName || file.name.replace(/\.json$/i, '').replace(/_/g, ' ');
                    minigameData = importedData.games;
                    selectedItems.clear();
                    updateAndRender(true);
                    alert(`Projeto "${projectName}" importado com sucesso!`);
                } else { alert('Erro: O arquivo JSON deve ser um objeto com as chaves "projectName" e "games".'); }
            } catch (err) { alert('Falha ao importar: Arquivo JSON inválido.'); }
        };
        reader.readAsText(file); e.target.value = '';
    });
    
    document.querySelectorAll('thead th[data-column]').forEach(th => {
        th.addEventListener('click', () => {
            const columnKey = th.dataset.column; const isAsc = currentSort.column === columnKey && currentSort.direction === 'asc';
            currentSort = { column: columnKey, direction: isAsc ? 'desc' : 'asc' };
            minigameData.sort((a, b) => {
                let valA = a[columnKey], valB = b[columnKey];
                return (typeof valA === 'number' && typeof valB === 'number') ? (valA - valB) : String(valA || '').toLowerCase().localeCompare(String(valB || '').toLowerCase());
            });
            if (currentSort.direction === 'desc') minigameData.reverse();
            document.querySelectorAll('thead th[data-column]').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            updateAndRender(true);
        });
    });

    document.getElementById('back-btn').addEventListener('click', (e) => { if (hasUnsavedChanges() && !confirm("Deseja voltar e perder as alterações não salvas?")) e.preventDefault(); });
    window.addEventListener('beforeunload', (e) => { if (hasUnsavedChanges()) { e.preventDefault(); e.returnValue = ''; } });
    
    // --- INICIALIZAÇÃO ---
    setupDetailsModal();
    loadAndApplyGlobalStyle();
    loadDataFromFirebase();
});
</script>
</body>
</html>