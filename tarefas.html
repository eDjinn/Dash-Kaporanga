<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Tarefas</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* ⭐️ INÍCIO DA SEÇÃO DE ESTILO HERDADA ⭐️ */
        :root {
            --primary-text-color: #1a2533;
            --secondary-text-color: #6c757d;
            --page-bg-color: #f4f7f9;
            --card-bg-color: rgba(255, 255, 255, 0.92);
            --card-shadow-color: rgba(0, 0, 0, 0.1);
            --accent-color: #007bff;
            --bg-image: none;
            --bg-opacity: 1;
        }

        body.dark-theme {
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #b0b0b0;
            --page-bg-color: #121212;
            --card-bg-color: rgba(40, 40, 40, 0.92);
            --card-shadow-color: rgba(0, 0, 0, 0.4);
            --accent-color: #4dabf7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--page-bg-color);
            color: var(--primary-text-color);
            margin: 0;
            padding: 0;
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: var(--bg-opacity);
            transition: opacity 0.3s ease, background-image 0.5s ease-in-out;
        }
        /* ⭐️ FIM DA SEÇÃO DE ESTILO HERDADA ⭐️ */

        .container { max-width: 950px; margin: 0 auto; padding: 20px; }
        
        .main-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 20px; 
            background-color: var(--card-bg-color); 
            box-shadow: 0 2px 4px var(--card-shadow-color);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000; 
            flex-wrap: wrap; gap: 15px;
            transition: padding 0.3s ease;
        }

        .header-left-group, .header-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .main-header h1 { margin: 0; font-size: 1.5em; }
        
        #search-input { width: 200px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; flex-grow: 1; max-width: 300px;}
        .header-actions .btn { padding: 8px 15px; flex-shrink: 0; }
        #bulk-actions-container { display: none; gap: 10px; align-items: center; flex-wrap: wrap; }
        #bulk-actions-container.visible { display: flex; }

        #primary-actions-container { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; transition: max-height 0.4s ease-out, opacity 0.3s ease; }
        
        .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-overlay.visible { display: flex; }
        
        .modal-content { background-color: var(--card-bg-color); padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px var(--card-shadow-color); width: 90%; max-width: 500px; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .modal-close:hover { color: var(--primary-text-color); }
        .modal-content h2 { text-align: center; margin-top: 0; }
        #modal-task-form-container, #modal-group-form-container, #modal-move-form-container { display: none; }
        #modal-task-form-container.visible, #modal-group-form-container.visible, #modal-move-form-container.visible { display: block; }
        .choice-buttons-container { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        
        h1, h2 { color: var(--primary-text-color); }
        h2 { text-align: left; }
        
        .card { background-color: var(--card-bg-color); padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow-color); }
        .form { display: flex; flex-direction: column; gap: 10px; }
        .form input, .form select { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn { padding: 10px 20px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; transition: background-color 0.2s; color: white; text-align: center; text-decoration: none; display: inline-flex; justify-content: center; align-items: center; }
        .btn-success { background-color: #28a745; }
        .btn-info { background-color: #17a2b8; }
        .btn-primary { background-color: #007bff; }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        #summary { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; }
        .summary-item { text-align: center; margin: 10px; flex-basis: 120px; flex-grow: 1; }
        
        .summary-item strong { display: block; font-size: 1.5em; color: var(--accent-color); }
        .summary-item span { font-size: 0.9em; color: var(--secondary-text-color); }
        #progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 5px; margin-top: 15px; height: 25px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background-color: #28a745; text-align: center; line-height: 25px; color: white; font-weight: bold; transition: width 0.4s ease; }
        .filters { text-align: center; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
        
        .filters button { padding: 8px 15px; margin: 0; border-radius: 20px; border: 1px solid var(--accent-color); background-color: transparent; color: var(--accent-color); cursor: pointer; }
        .filters button.active, .filters button:hover { background-color: var(--accent-color); color: white; }
        
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        #tasks-table-container { background-color: var(--card-bg-color); border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow-color); overflow-x: auto; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: middle; transition: background-color 0.2s; }
        
        th { background-color: var(--accent-color); color: white; font-weight: bold; text-align: center; }
        th.col-task { text-align: left; width: 50%; }
        .task-row { background-color: transparent; cursor: grab; user-select: none; }
        .task-row.selected > td { background-color: #fff3cd; }
        .task-row.sortable-ghost { background-color: #cce5ff; opacity: 0.7; }
        
        .is-group > td { font-weight: bold; background-color: rgba(0,0,0,0.05); }
        body.dark-theme .is-group > td { background-color: rgba(255,255,255,0.05); }

        .toggle-children { cursor: pointer; display: inline-block; width: 20px; text-align: center; font-family: monospace; font-size: 1.2em; }
        .control-group { display: flex; align-items: center; gap: 5px; justify-content: center; }
        .control-group button { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ccc; background-color: #f0f0f0; cursor: pointer; font-size: 16px; line-height: 26px; text-align: center; padding: 0; }
        .control-group button:disabled { opacity: 0.4; cursor: not-allowed; }
        .control-group .display { font-weight: bold; padding: 5px; border-radius: 5px; min-width: 50px; text-align: center; font-size: 0.9em; }
        .progress-display.status-0 { background-color: #f8d7da; } .progress-display.status-25 { background-color: #fff3cd; } .progress-display.status-50 { background-color: #cce5ff; } .progress-display.status-75 { background-color: #d4edda; } .progress-display.status-100 { background-color: #a2e8a5; }
        .edit-btn { cursor: pointer; margin-left: 8px; font-size: 0.8em; opacity: 0; transition: opacity 0.2s; }
        .task-row:hover .edit-btn { opacity: 0.7; }
        .edit-btn:hover { opacity: 1; }
        #back-btn { width: 40px; height: 40px; padding: 0; border-radius: 50%; }
        #back-btn svg { width: 22px; height: 22px; }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header-left-group { flex-grow: 1; }
            #search-input { min-width: 150px; }
            .header-actions { justify-content: flex-end; }
            .summary-item { flex-basis: 40%; }
            .header-scrolled #primary-actions-container,
            #bulk-actions-container.visible ~ #primary-actions-container {
                overflow: hidden; opacity: 0; max-height: 0;
            }

            /* Melhorias Mobile */
            table { table-layout: fixed; }
            th, td { padding: 10px 2px; }
            .col-task { width: 45% !important; word-break: break-word; }
            .col-task span { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
            .col-progresso, .col-dias { width: 25%; }
            .control-group { gap: 2px; }
            .control-group .display { min-width: 35px; padding: 4px 2px; font-size: 0.85em; }
        }
    </style>
</head>
<body>
    <div class="main-header">
        <div class="header-left-group">
             <a href="index.html" id="back-btn" class="btn btn-secondary" title="Voltar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </a>
            <h1>Tarefas</h1>
            <input type="text" id="search-input" placeholder="Pesquisar tarefas...">
        </div>
        <div class="header-actions">
            <div id="bulk-actions-container">
                <button id="bulk-move-btn" class="btn btn-secondary">Mover Para</button>
                <button id="bulk-done-btn" class="btn btn-success">Completar</button>
                <button id="bulk-redo-btn" class="btn btn-info">Refazer</button>
                <button id="bulk-delete-btn" class="btn btn-danger">Excluir</button>
            </div>
            <button id="show-add-choice-modal-btn" class="btn btn-success">Adicionar</button>
            <div id="primary-actions-container">
                <div class="file-input-wrapper">
                    <button class="btn btn-secondary">Importar</button>
                    <input type="file" id="import-json-input" accept=".json">
                </div>
                <button id="export-json-btn" class="btn btn-primary">Exportar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card" id="summary"></div>
        <div class="filters card"></div>
        <div id="tasks-table-container">
            <table>
                <thead>
                    <tr id="tasks-thead-row"></tr>
                </thead>
                <tbody id="tasks-tbody"></tbody>
            </table>
        </div>
    </div>
    
    <div id="add-choice-modal" class="modal-overlay">
        <div class="modal-content">
             <span class="modal-close">×</span>
             <h2>O que você deseja adicionar?</h2>
             <div class="choice-buttons-container">
                <button id="choice-add-task-btn" class="btn btn-success">Nova Tarefa</button>
                <button id="choice-add-group-btn" class="btn btn-info">Novo Grupo</button>
             </div>
        </div>
    </div>

    <div id="add-item-modal" class="modal-overlay"></div>
    <div id="move-item-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">×</span>
            <div id="modal-move-form-container" class="visible">
                <h2>Mover Itens Selecionados</h2>
                <form id="move-items-form" class="form">
                    <p><strong id="move-selection-count">0</strong> item(ns) selecionado(s).</p>
                    <label for="move-target-group">Mover para o grupo:</label>
                    <select id="move-target-group"></select>
                    <button type="submit" class="btn btn-primary">Confirmar Movimentação</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    
    <script>
    // ===================================================================
    //  BLOCO DE CONFIGURAÇÃO E LÓGICA DO FIREBASE
    // ===================================================================

    const firebaseConfig = {
        apiKey: "AIzaSyC9OjBDOX9UUlCrPuhIZj5ipolRT4Gu420",
        authDomain: "gerenciadorcentral-f01e3.firebaseapp.com",
        projectId: "gerenciadorcentral-f01e3",
        storageBucket: "gerenciadorcentral-f01e3.appspot.com",
        messagingSenderId: "8874050225",
        appId: "1:8874050225:web:a536c7feb14f36af7cd890"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tasksDocRef = db.collection('settings').doc('tasks-data');
    const styleDocRef = db.collection('settings').doc('main-dashboard');

    let tasksData = [], progressData = {}, collapsedGroups = new Set(), projectName = 'Novo Projeto', selectedItems = new Set();
    let initialDataState = '';
    let deliveryDate = null; 

    document.addEventListener('DOMContentLoaded', () => {
        buildPageHTML(); 
        loadAndApplyGlobalStyle();
        loadDataFromFirebase();
        setupEventListeners();
        updateContainerPadding();
    });

    function updateContainerPadding() {
        const header = document.querySelector('.main-header');
        const container = document.querySelector('.container');
        if (header && container) {
            const headerHeight = header.offsetHeight;
            container.style.paddingTop = `${headerHeight + 20}px`;
        }
    }

    function handleHeaderScroll() {
        if (window.matchMedia('(max-width: 768px)').matches) {
            const header = document.querySelector('.main-header');
            if (window.scrollY > 10) {
                header.classList.add('header-scrolled');
            } else {
                header.classList.remove('header-scrolled');
            }
        }
        updateContainerPadding();
    }

    async function loadAndApplyGlobalStyle() {
        try {
            const doc = await styleDocRef.get();
            if (doc.exists && doc.data().styleData) {
                const style = doc.data().styleData;
                const body = document.body;
                const root = document.documentElement;
                body.className = '';
                body.classList.add(style.theme || 'light-theme');
                body.style.backgroundColor = style.bgColor;
                root.style.setProperty('--bg-image', style.bgImage ? `url('${style.bgImage}')` : 'none');
                root.style.setProperty('--bg-opacity', style.bgOpacity || '1');
            }
        } catch (e) { console.error("Não foi possível carregar os estilos do Firebase.", e); }
    }

    function loadDataFromFirebase() {
        tasksDocRef.onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                tasksData = transformData(data.tasks || []);
                progressData = data.progress || {};
                collapsedGroups = new Set(data.collapsed || []);
                projectName = data.name || 'Novo Projeto';
                deliveryDate = data.deliveryDate || '2025-08-27';
            } else {
                tasksData = []; progressData = {}; collapsedGroups = new Set();
                projectName = 'Novo Projeto'; deliveryDate = '2025-08-27';
            }
            renderAndCalculate(false);
            initialDataState = getCanonicalState(); 
        }, error => { console.error("Erro ao carregar dados das tarefas: ", error); alert("Não foi possível conectar ao banco de dados das tarefas."); });
    }

    function saveDataToFirebase() {
        const currentState = JSON.parse(getCanonicalState());
        tasksDocRef.set(currentState)
            .then(() => { console.log("Dados das tarefas salvos no Firebase."); initialDataState = getCanonicalState(); })
            .catch((error) => { console.error("Erro ao salvar dados no Firebase: ", error); });
    }

    const getCanonicalState = () => {
        const state = { tasks: tasksData, progress: progressData, collapsed: Array.from(collapsedGroups).sort(), name: projectName, deliveryDate: deliveryDate };
        const cleanTasks = JSON.parse(JSON.stringify(state.tasks));
        const cleanRecursive = (tasks) => {
            tasks.forEach(task => {
                delete task._totalDias; delete task._completedDias; delete task._progress;
                if (task.children) cleanRecursive(task.children);
            });
        };
        cleanRecursive(cleanTasks);
        state.tasks = cleanTasks;
        return JSON.stringify(state, null, 2);
    };
    
    const hasUnsavedChanges = () => getCanonicalState() !== initialDataState;

    function renderAndCalculate(doSave = true) {
        calculateAllTotals();
        renderTable();
        updateGroupDropdown('new-task-group');
        updateGroupDropdown('new-group-parent');
        updateSummary();
        updateBulkActionsBar();
        if (doSave) saveDataToFirebase();
    }
    
    // ===================================================================
    //  FIM DO BLOCO FIREBASE
    // ===================================================================
    
    function setupEventListeners() {
        document.getElementById('add-task-form').addEventListener('submit', handleAddTask);
        document.getElementById('add-group-form').addEventListener('submit', handleAddGroup);
        
        document.getElementById('show-add-choice-modal-btn').addEventListener('click', () => openModal('add-choice-modal'));
        document.getElementById('choice-add-task-btn').addEventListener('click', () => { closeModal('add-choice-modal'); openModal('add-item-modal', 'task'); });
        document.getElementById('choice-add-group-btn').addEventListener('click', () => { closeModal('add-choice-modal'); openModal('add-item-modal', 'group'); });
        
        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-overlay').id)));
        document.querySelectorAll('.modal-overlay').forEach(modal => modal.addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) closeModal(e.target.id); }));
        document.getElementById('tasks-tbody').addEventListener('click', handleTableClick);
        document.getElementById('export-json-btn').addEventListener('click', handleExport);
        document.getElementById('import-json-input').addEventListener('change', handleImport);
        document.querySelector('.filters').addEventListener('click', (e) => { if (e.target.classList.contains('filter-btn')) applyFilter(e.target.dataset.filter, true); });
        document.getElementById('search-input').addEventListener('keyup', () => { const activeFilter = document.querySelector('.filters .filter-btn.active')?.dataset.filter || 'all'; applyFilter(activeFilter, false); });
        document.getElementById('bulk-delete-btn').addEventListener('click', handleBulkDelete);
        document.getElementById('bulk-done-btn').addEventListener('click', () => handleBulkProgress(1));
        document.getElementById('bulk-redo-btn').addEventListener('click', () => handleBulkProgress(0));
        document.getElementById('bulk-move-btn').addEventListener('click', openMoveModal);
        document.getElementById('move-items-form').addEventListener('submit', handleBulkMove);
        document.getElementById('summary').addEventListener('click', (e) => { if (e.target.closest('.summary-item')?.querySelector('#countdown-days')) { handleChangeDeliveryDate(); }});
        document.getElementById('back-btn').addEventListener('click', (e) => { if (hasUnsavedChanges() && !confirm("Você tem alterações não salvas. Deseja voltar e perder as alterações?")) e.preventDefault(); });
        window.addEventListener('beforeunload', (e) => { if (hasUnsavedChanges()) { e.preventDefault(); e.returnValue = ''; return ''; } });
        
        window.addEventListener('resize', () => {
            updateContainerPadding();
            renderTable(); // Re-render table on resize to swap columns correctly
        });
        window.addEventListener('scroll', handleHeaderScroll);

        document.addEventListener('keydown', (e) => {
            const choiceModal = document.getElementById('add-choice-modal');
            const itemModal = document.getElementById('add-item-modal');
            const moveModal = document.getElementById('move-item-modal');

            if (e.key === 'Escape') {
                if (choiceModal.classList.contains('visible')) closeModal('add-choice-modal');
                if (itemModal.classList.contains('visible')) closeModal('add-item-modal');
                if (moveModal.classList.contains('visible')) closeModal('move-item-modal');
            }

            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                if (itemModal.classList.contains('visible')) {
                    const taskFormContainer = document.getElementById('modal-task-form-container');
                    if (taskFormContainer.classList.contains('visible')) {
                        document.getElementById('add-task-form').requestSubmit();
                    } else {
                        document.getElementById('add-group-form').requestSubmit();
                    }
                } else if (moveModal.classList.contains('visible')) {
                    document.getElementById('move-items-form').requestSubmit();
                }
            }
        });
    }
    
    function buildPageHTML() {
        document.getElementById('summary').innerHTML = `<div class="summary-item"><strong id="total-dias">0</strong><span>Total de Dias</span></div><div class="summary-item"><strong id="dias-restantes">0.00</strong><span>Dias Restantes</span></div><div class="summary-item"><strong id="countdown-days">0</strong><span>Até a Entrega</span></div><div class="summary-item"><strong id="progresso-geral">0%</strong><span>Progresso Geral</span></div><div id="progress-bar-container"><div id="progress-bar"></div></div>`;
        document.querySelector('.filters').innerHTML = `<button class="filter-btn active" data-filter="all">Tudo</button><button class="filter-btn" data-filter="not-started">Não Iniciados (0%)</button><button class="filter-btn" data-filter="in-progress">Em Andamento</button><button class="filter-btn" data-filter="not-done">Não Concluídos</button><button class="filter-btn" data-filter="done">Concluídos</button>`;
        document.getElementById('add-item-modal').innerHTML = `<div class="modal-content"><span class="modal-close">×</span><div id="modal-task-form-container"><h2>Adicionar Nova Tarefa</h2><form id="add-task-form" class="form"><input type="text" id="new-task-name" placeholder="Nome da Tarefa" required><input type="number" id="new-task-days" placeholder="Dias" step="0.01" min="0" required><label for="new-task-group">Adicionar em:</label><select id="new-task-group"></select><button type="submit" class="btn btn-success">Adicionar Tarefa</button></form></div><div id="modal-group-form-container"><h2>Adicionar Novo Grupo</h2><form id="add-group-form" class="form"><input type="text" id="new-group-name" placeholder="Nome do Grupo" required><label for="new-group-parent">Adicionar em:</label><select id="new-group-parent"></select><button type="submit" class="btn btn-info">Adicionar Grupo</button></form></div></div>`;
    }

    function renderTableHeader() {
        const headerRow = document.getElementById('tasks-thead-row');
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        headerRow.innerHTML = ''; // Limpa o cabeçalho

        const taskHeader = document.createElement('th');
        taskHeader.className = 'col-task';
        taskHeader.innerHTML = 'Tarefa';
        headerRow.appendChild(taskHeader);

        const progressHeader = document.createElement('th');
        progressHeader.className = 'col-progresso';
        progressHeader.innerHTML = 'Progresso';

        const daysHeader = document.createElement('th');
        daysHeader.className = 'col-dias';
        daysHeader.innerHTML = 'Dias';

        if (isMobile) {
            headerRow.appendChild(progressHeader);
            headerRow.appendChild(daysHeader);
        } else {
            headerRow.appendChild(daysHeader);
            headerRow.appendChild(progressHeader);
        }

        const checkboxHeader = document.createElement('th');
        checkboxHeader.className = 'col-checkbox';
        checkboxHeader.style.width = '20px';
        checkboxHeader.innerHTML = `<input type="checkbox" id="select-all-checkbox">`;
        headerRow.appendChild(checkboxHeader);

        // Re-attach event listener
        document.getElementById('select-all-checkbox').addEventListener('change', handleSelectAll);
    }


    function renderTable() {
        renderTableHeader(); // Renderiza o cabeçalho de acordo com a tela
        const tableBody = document.getElementById('tasks-tbody');
        const activeFilter = document.querySelector('.filters .filter-btn.active')?.dataset.filter || 'all';
        tableBody.innerHTML = ''; 
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        
        const createRowsRecursive = (tasks, level = 0) => {
            tasks.forEach(task => {
                const isGroup = task.type === 'group';
                const row = document.createElement('tr');
                row.className = 'task-row';
                if(isGroup) row.classList.add('is-group');
                if(selectedItems.has(task.id)) row.classList.add('selected');
                row.dataset.id = task.id;
                
                const servicoCell = row.insertCell();
                servicoCell.className = 'col-task';
                servicoCell.style.paddingLeft = `${5 + level * 25}px`;
                servicoCell.innerHTML = (isGroup ? `<span class="toggle-children">${collapsedGroups.has(task.id) ? '▶' : '▼'}</span>` : '') + `<span>${task.servico}</span><span class="edit-btn">✏️</span>`;
                
                const diasDisplay = (task._totalDias || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                const progressPercentage = Math.round((task._progress || 0) * 100);

                const diasHTML = `<div class="control-group"><button class="dias-btn" data-delta="-0.25" ${isGroup ? 'disabled' : ''}>-</button><span class="display dias-display">${diasDisplay}</span><button class="dias-btn" data-delta="0.25" ${isGroup ? 'disabled' : ''}>+</button></div>`;
                const progressHTML = `<div class="control-group"><button class="progress-btn" data-delta="-0.25" ${isGroup ? 'disabled' : ''}>-</button><span class="display progress-display status-${progressPercentage}">${progressPercentage}%</span><button class="progress-btn" data-delta="0.25" ${isGroup ? 'disabled' : ''}>+</button></div>`;

                if (isMobile) {
                    const progressCell = row.insertCell();
                    progressCell.className = 'col-progresso';
                    progressCell.innerHTML = progressHTML;
                    const diasCell = row.insertCell();
                    diasCell.className = 'col-dias';
                    diasCell.innerHTML = diasHTML;
                } else {
                    const diasCell = row.insertCell();
                    diasCell.className = 'col-dias';
                    diasCell.innerHTML = diasHTML;
                    const progressCell = row.insertCell();
                    progressCell.className = 'col-progresso';
                    progressCell.innerHTML = progressHTML;
                }
                
                const checkboxCell = row.insertCell();
                checkboxCell.className = 'col-checkbox';
                checkboxCell.innerHTML = `<input type="checkbox" class="select-checkbox" ${selectedItems.has(task.id) ? 'checked' : ''}>`;
                
                tableBody.appendChild(row);

                if (isGroup && !collapsedGroups.has(task.id)) createRowsRecursive(task.children, level + 1);
            });
        };
        
        createRowsRecursive(tasksData);

        new Sortable(tableBody, { group: 'nested-tasks', animation: 150, delay: 200, delayOnTouchOnly: true, onEnd: handleDragEnd });
        applyFilter(activeFilter, false); 
    }
    
    function calculateAllTotals() {
        const calculateRecursive = (task) => {
            if (task.type === 'group') {
                task.children.forEach(calculateRecursive);
                task._totalDias = task.children.reduce((sum, child) => sum + child._totalDias, 0);
                task._completedDias = task.children.reduce((sum, child) => sum + child._completedDias, 0);
            } else {
                task._totalDias = task.dias;
                task._completedDias = task.dias * (progressData[task.id] || 0);
            }
            task._progress = task._totalDias > 0 ? (task._completedDias / task._totalDias) : 0;
        };
        tasksData.forEach(calculateRecursive);
    }
    
    function openModal(id, type) {
        const modal = document.getElementById(id);
        if (type) {
            modal.querySelector('#modal-task-form-container').classList.toggle('visible', type === 'task');
            modal.querySelector('#modal-group-form-container').classList.toggle('visible', type === 'group');
            if (type === 'task') updateGroupDropdown('new-task-group');
            else if (type === 'group') updateGroupDropdown('new-group-parent');
        }
        modal.classList.add('visible');
    }

    function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
    function createUniqueId() { return `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; }
    
    function transformData(data) {
        return (data || []).map(item => ({
            id: item.id || createUniqueId(),
            servico: item.servico,
            dias: item.dias === undefined ? 0 : item.dias,
            type: item.type || (item.children ? 'group' : 'task'),
            children: transformData(item.children)
        }));
    }
    
    function updateGroupDropdown(dropdownId, excludeIds = new Set()) {
        const dropdown = document.getElementById(dropdownId);
        const currentVal = dropdown.value;
        dropdown.innerHTML = '<option value="root">Nível Principal (Raiz)</option>';
        const addGroupsToDropdown = (tasks, level) => {
            tasks.forEach(task => {
                if (task.type === 'group' && !excludeIds.has(task.id)) {
                    dropdown.add(new Option(`${'--'.repeat(level)} ${task.servico}`, task.id));
                    if (!collapsedGroups.has(task.id)) addGroupsToDropdown(task.children, level + 1);
                }
            });
        };
        addGroupsToDropdown(tasksData, 0);
        dropdown.value = currentVal;
    }

    function getAllItemsAsMap(tasks = tasksData) {
        const map = new Map();
        const recurse = (items) => {
            for (const item of items) {
                map.set(item.id, item);
                if (item.children) recurse(item.children);
            }
        };
        recurse(tasks);
        return map;
    }
    
    function findParentList(list, childId) {
        for (let i = 0; i < list.length; i++) {
            const item = list[i];
            if (item.id === childId) return { parentList: list, index: i };
            if (item.type === 'group') {
                const found = findParentList(item.children, childId);
                if (found) return found;
            }
        }
        return null;
    }

    function handleDragEnd(evt) {
        const movedItemId = evt.item.dataset.id;
        const allItemsMap = getAllItemsAsMap();
        const movedItem = allItemsMap.get(movedItemId);
        if (!movedItem) return;
        findAndDelete(tasksData, new Set([movedItemId]));
        const prevSiblingEl = evt.item.previousElementSibling;
        let destinationList, destinationIndex;
        if (!prevSiblingEl) {
            destinationList = tasksData;
            destinationIndex = 0;
        } else {
            const prevSiblingId = prevSiblingEl.dataset.id;
            const prevSiblingItem = allItemsMap.get(prevSiblingId);
            if (prevSiblingItem.type === 'group' && !collapsedGroups.has(prevSiblingId)) {
                destinationList = prevSiblingItem.children;
                destinationIndex = 0;
            } else {
                const parentInfo = findParentList(tasksData, prevSiblingId);
                destinationList = parentInfo ? parentInfo.parentList : tasksData;
                destinationIndex = parentInfo ? parentInfo.index + 1 : tasksData.length;
            }
        }
        destinationList.splice(destinationIndex, 0, movedItem);
        renderAndCalculate(true);
    }
    
    function updateSummary() {
        const totalProjectDias = tasksData.reduce((sum, task) => sum + (task._totalDias || 0), 0);
        const totalProjectCompletedDias = tasksData.reduce((sum, task) => sum + (task._completedDias || 0), 0);
        document.getElementById('total-dias').textContent = totalProjectDias.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('dias-restantes').textContent = (totalProjectDias - totalProjectCompletedDias).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const progressoGeral = totalProjectDias > 0 ? (totalProjectCompletedDias / totalProjectDias) * 100 : 0;
        document.getElementById('progresso-geral').textContent = `${progressoGeral.toFixed(1).replace('.', ',')}%`;
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = `${progressoGeral}%`;
        progressBar.textContent = `${progressoGeral.toFixed(1)}%`;
        const countdownEl = document.getElementById('countdown-days');
        countdownEl.parentElement.style.cursor = 'pointer';
        countdownEl.parentElement.title = 'Clique para alterar a data de entrega';
        if (deliveryDate) {
            const targetDate = new Date(deliveryDate + 'T23:59:59');
            const diffDays = Math.ceil((targetDate - new Date()) / 86400000);
            countdownEl.textContent = diffDays >= 0 ? diffDays : 'Atrasado!';
            countdownEl.style.color = diffDays < 0 ? '#dc3545' : '';
        } else {
            countdownEl.textContent = 'N/D';
            countdownEl.style.color = '';
        }
    }
    
    function handleChangeDeliveryDate() {
        const currentDate = deliveryDate || new Date().toISOString().slice(0, 10);
        const newDateStr = prompt("Digite a nova data de entrega (formato AAAA-MM-DD):", currentDate);
        if (newDateStr && /^\d{4}-\d{2}-\d{2}$/.test(newDateStr)) {
            deliveryDate = newDateStr;
            renderAndCalculate(true);
        } else if (newDateStr !== null) {
            alert("Formato de data inválido. Por favor, use o formato AAAA-MM-DD.");
        }
    }

    function handleTableClick(e) {
        const row = e.target.closest('.task-row');
        if (!row) return;
        const id = row.dataset.id;
        const item = getAllItemsAsMap().get(id);
        if (!item) return;

        if (e.target.classList.contains('select-checkbox')) {
            if (e.target.checked) selectedItems.add(id); else selectedItems.delete(id);
            updateBulkActionsBar();
            row.classList.toggle('selected', e.target.checked);
            return;
        }
        if (e.target.classList.contains('toggle-children')) { if (collapsedGroups.has(id)) collapsedGroups.delete(id); else collapsedGroups.add(id); }
        else if (e.target.classList.contains('edit-btn')) { const newName = prompt("Editar nome:", item.servico); if (newName?.trim()) item.servico = newName.trim(); }
        else if (e.target.classList.contains('progress-btn')) { const delta = parseFloat(e.target.dataset.delta); progressData[id] = Math.max(0, Math.min(1, Math.round(((progressData[id] || 0) + delta) * 100) / 100)); }
        else if (e.target.classList.contains('dias-btn')) { item.dias = Math.max(0.25, item.dias + parseFloat(e.target.dataset.delta)); }
        renderAndCalculate(true);
    }
    
    function applyFilter(filterType, changeActiveButton = true) {
        if (changeActiveButton) {
            document.querySelector('.filters .filter-btn.active')?.classList.remove('active');
            document.querySelector(`.filters .filter-btn[data-filter="${filterType}"]`)?.classList.add('active');
        }
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const checkFilter = (task) => {
            switch(filterType) {
                case 'not-started': return task._progress === 0;
                case 'in-progress': return task._progress > 0 && task._progress < 1;
                case 'done': return task._progress === 1;
                case 'not-done': return task._progress < 1;
                default: return true;
            }
        };
        const findVisibleRecursive = (tasks) => {
            let visibleIds = new Set();
            tasks.forEach(task => {
                const searchMatch = task.servico.toLowerCase().includes(searchTerm);
                let selfIsVisible = checkFilter(task) && searchMatch;
                let childIsVisible = false;
                if(task.type === 'group') {
                    const visibleChildren = findVisibleRecursive(task.children);
                    childIsVisible = visibleChildren.size > 0;
                    visibleChildren.forEach(id => visibleIds.add(id));
                }
                if(selfIsVisible || childIsVisible) visibleIds.add(task.id);
            });
            return visibleIds;
        };
        const visibleIds = findVisibleRecursive(tasksData);
        document.querySelectorAll('#tasks-tbody .task-row').forEach(row => row.style.display = visibleIds.has(row.dataset.id) ? '' : 'none');
    }
    
    function handleAddTask(e) {
        e.preventDefault();
        const nameInput = document.getElementById('new-task-name');
        const daysInput = document.getElementById('new-task-days');
        const parentGroupId = document.getElementById('new-task-group').value;
        const newTask = { id: createUniqueId(), servico: nameInput.value.trim(), dias: parseFloat(daysInput.value) || 0, type: 'task', children: [] };
        const parentList = (parentGroupId === 'root') ? tasksData : getAllItemsAsMap().get(parentGroupId)?.children;
        if (parentList) parentList.push(newTask);
        nameInput.value = ''; daysInput.value = '';
        closeModal('add-item-modal');
        renderAndCalculate(true);
    }

    function handleAddGroup(e) {
        e.preventDefault();
        const nameInput = document.getElementById('new-group-name');
        const parentGroupId = document.getElementById('new-group-parent').value;
        const newGroup = { id: createUniqueId(), servico: nameInput.value.trim(), dias: 0, type: 'group', children: [] };
        const parentList = (parentGroupId === 'root') ? tasksData : getAllItemsAsMap().get(parentGroupId)?.children;
        if (parentList) parentList.push(newGroup);
        nameInput.value = '';
        closeModal('add-item-modal');
        renderAndCalculate(true);
    }

    function handleExport() {
        const dataToExport = getCanonicalState();
        try {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([dataToExport], { type: 'application/json' }));
            a.download = `${projectName.replace(/ /g,"_")}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        } catch(e) { console.error("Erro ao exportar:", e); alert("Ocorreu um erro ao gerar o arquivo para download."); }
    }

    function handleImport(event) {
        if (hasUnsavedChanges() && !confirm("Isto irá substituir todos os dados do projeto atual com o conteúdo do arquivo. Deseja continuar?")) {
            event.target.value = ''; return;
        }
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                tasksData = transformData(data.tasks || []);
                progressData = data.progress || {};
                collapsedGroups = new Set(data.collapsed || []);
                projectName = data.name || file.name.replace(/\.json$/i, '').replace(/_/g, ' ');
                deliveryDate = data.deliveryDate || null;
                renderAndCalculate(true); 
                alert(`Projeto "${projectName}" importado e salvo com sucesso!`);
            } catch(err) { console.error("Erro ao processar JSON:", err); alert("Erro ao ler o arquivo JSON. Verifique o formato do arquivo."); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    
    function updateBulkActionsBar() {
        const container = document.getElementById('bulk-actions-container');
        container.classList.toggle('visible', selectedItems.size > 0);
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) {
            const visibleRows = document.querySelectorAll('#tasks-tbody .task-row:not([style*="display: none"])');
            selectAllCheckbox.checked = (visibleRows.length > 0 && selectedItems.size === visibleRows.length);
        }
        // Chamada incondicional para corrigir o layout em desktop e mobile
        updateContainerPadding(); 
    }

    function handleSelectAll(e) {
        selectedItems.clear();
        if (e.target.checked) document.querySelectorAll('#tasks-tbody .task-row:not([style*="display: none"])').forEach(row => selectedItems.add(row.dataset.id));
        renderAndCalculate(false);
    }
    
    function findAndDelete(items, idsToDelete) {
        for (let i = items.length - 1; i >= 0; i--) {
            const item = items[i];
            if (idsToDelete.has(item.id)) items.splice(i, 1);
            else if (item.children) findAndDelete(item.children, idsToDelete);
        }
    }

    function handleBulkDelete() {
        if (selectedItems.size === 0 || !confirm(`Tem certeza que deseja excluir ${selectedItems.size} item(ns)?`)) return;
        findAndDelete(tasksData, selectedItems);
        selectedItems.clear();
        renderAndCalculate(true);
    }

    function handleBulkProgress(value) {
        if (selectedItems.size === 0 || !confirm(`Tem certeza que deseja ${value === 1 ? 'completar' : 'refazer'} ${selectedItems.size} item(ns)?`)) return;
        const allItems = getAllItemsAsMap();
        const taskIdsToUpdate = new Set();
        const getChildTasks = (item) => {
            if(!item) return;
            if (item.type === 'task') taskIdsToUpdate.add(item.id);
            else if (item.children) item.children.forEach(getChildTasks);
        };
        selectedItems.forEach(id => getChildTasks(allItems.get(id)));
        taskIdsToUpdate.forEach(id => { progressData[id] = value; });
        selectedItems.clear();
        renderAndCalculate(true);
    }

    function openMoveModal() {
        if (selectedItems.size === 0) return;
        const allItems = getAllItemsAsMap();
        const allDescendantIds = new Set();
        const getDescendantIds = (item) => {
            if(!item) return;
            allDescendantIds.add(item.id);
            if (item.children) item.children.forEach(getDescendantIds);
        };
        selectedItems.forEach(id => getDescendantIds(allItems.get(id)));
        updateGroupDropdown('move-target-group', allDescendantIds);
        document.getElementById('move-selection-count').textContent = selectedItems.size;
        openModal('move-item-modal');
    }

    function handleBulkMove(e) {
        e.preventDefault();
        const targetGroupId = document.getElementById('move-target-group').value;
        const allItems = getAllItemsAsMap();
        const itemsToMove = [];
        selectedItems.forEach(id => {
            const item = allItems.get(id);
            if(item) itemsToMove.push(item);
        });
        
        findAndDelete(tasksData, selectedItems);
        
        const destinationList = (targetGroupId === 'root') ? tasksData : allItems.get(targetGroupId)?.children;
        if (destinationList) destinationList.push(...itemsToMove);
        
        selectedItems.clear();
        closeModal('move-item-modal');
        renderAndCalculate(true);
    }
    </script>
</body>
</html>