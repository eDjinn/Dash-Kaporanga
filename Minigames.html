<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Minijogos</title>
    <style>
        /* ⭐️ INÍCIO DA SEÇÃO DE ESTILO HERDADA ⭐️ */
        :root {
            --primary-text-color: #1a2533;
            --secondary-text-color: #6c757d;
            --page-bg-color: #f4f7f9;
            --card-bg-color: rgba(255, 255, 255, 0.92);
            --card-shadow-color: rgba(0, 0, 0, 0.1);
            --accent-color: #007bff;
            --bg-image: none;
            --bg-opacity: 1;
        }

        body.dark-theme {
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #b0b0b0;
            --page-bg-color: #121212;
            --card-bg-color: rgba(40, 40, 40, 0.92);
            --card-shadow-color: rgba(0, 0, 0, 0.4);
            --accent-color: #4dabf7;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            /* Modificado para usar variáveis */
            background-color: var(--page-bg-color); 
            color: var(--primary-text-color); 
            margin: 0; 
            padding: 0; 
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: var(--bg-opacity);
            transition: opacity 0.3s ease, background-image 0.5s ease-in-out;
        }
        /* ⭐️ FIM DA SEÇÃO DE ESTILO HERDADA ⭐️ */

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; padding-top: 90px; }
        
        .main-header { 
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; 
            /* Modificado para usar variáveis */
            background-color: var(--card-bg-color); 
            box-shadow: 0 2px 4px var(--card-shadow-color);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000; 
        }

        .header-left-group, .header-actions { display: flex; align-items: center; gap: 10px; }
        .main-header h1, .main-header h2 { margin: 0; }
        .main-header h1 { font-size: 1.5em; }
        
        /* Modificado para usar variáveis */
        #project-name { font-size: 1.1em; color: var(--secondary-text-color); font-weight: normal; }
        
        .separator { color: #ccc; font-size: 1.5em; }
        .header-actions .btn { padding: 8px 15px; }
        #bulk-actions-container { display: none; }
        #bulk-actions-container.visible { display: flex; align-items: center; gap: 10px; }
        .btn { border-radius: 4px; border: none; font-weight: bold; cursor: pointer; transition: background-color 0.2s; color: white; text-align: center; text-decoration: none; display: inline-flex; justify-content: center; align-items: center; }
        .btn-success { background-color: #28a745; }
        .btn-primary { background-color: var(--accent-color); } /* Modificado */
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        
        #back-btn { width: 40px; height: 40px; padding: 0; border-radius: 50%; }
        #back-btn svg { width: 22px; height: 22px; }

        .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-overlay.visible { display: flex; }
        
        .modal-content { 
            /* Modificado para usar variáveis */
            background-color: var(--card-bg-color); 
            color: var(--primary-text-color);
            padding: 25px; border-radius: 8px; 
            box-shadow: 0 5px 15px var(--card-shadow-color); 
            width: 90%; max-width: 680px; position: relative; max-height: 90vh; overflow-y: auto; 
        }

        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .form { display: flex; flex-direction: column; gap: 10px; }
        .form label { font-weight: bold; margin-top: 5px; }
        .form input, .form textarea { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        #search-input { width: 250px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
        
        #curiosity-photo-container { 
            width: 100%; max-width: 636px; height: 450px; border: 2px dashed #ccc; border-radius: 4px; 
            display: flex; justify-content: center; align-items: center; cursor: pointer; 
            background-color: var(--page-bg-color); /* Modificado */
            margin-top: 10px; overflow: hidden; 
        }

        #curiosity-photo-container:hover { border-color: var(--accent-color); }
        #curiosity-photo-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        #curiosity-photo-placeholder { color: var(--secondary-text-color); text-align: center; } /* Modificado */
        #char-counter { text-align: right; font-size: 0.8em; color: var(--secondary-text-color); } /* Modificado */
        .curiosity-item { cursor: pointer; display: block; margin-bottom: 5px; color: #0056b3; text-decoration: underline; }
        .modal-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        #table-container { 
            /* Modificado para usar variáveis */
            background-color: var(--card-bg-color); 
            border-radius: 8px; 
            box-shadow: 0 2px 4px var(--card-shadow-color);
            overflow: hidden; 
        }

        th, td { padding: 12px 15px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: top; word-wrap: break-word; }
        
        /* Modificado para usar variáveis */
        th { background-color: var(--accent-color); color: white; font-weight: bold; user-select: none; position: relative; }

        th[data-column] { cursor: pointer; }
        th[data-column]::after { content: ' \2195'; opacity: 0.4; }
        th[data-column].sorted-asc::after { content: ' \2191'; opacity: 1; }
        th[data-column].sorted-desc::after { content: ' \2193'; opacity: 1; }
        th.no-sort { cursor: default; }
        
        tr.selected-row > td { background-color: #fff3cd !important; }
        /* Modificado para usar um overlay sutil */
        tr:hover > td { background-color: rgba(128, 128, 128, 0.1); }
        body.dark-theme tr:hover > td { background-color: rgba(128, 128, 128, 0.2); }

        td.editable { cursor: pointer; position: relative; }
        .edit-pencil { display: inline-block; opacity: 0; transition: opacity 0.2s ease-in-out; margin-left: 8px; font-size: 0.9em; }
        td.editable:hover .edit-pencil, .reference-item:hover .edit-pencil { opacity: 0.6; }
        .edit-pencil:hover { opacity: 1; }
        
        /* Modificado para usar variáveis */
        .inline-edit-input { width: 95%; padding: 8px; margin: -9px -10px; border: 2px solid var(--accent-color); border-radius: 4px; font-family: inherit; font-size: inherit; box-sizing: border-box; }
        .reference-item { display: flex; align-items: center; margin-bottom: 5px; }
        .reference-item a { color: var(--accent-color); text-decoration: none; flex-grow: 1; }
        
        .add-btn { display: inline-block; cursor: pointer; margin-top: 8px; padding: 2px 8px; border: 1px dashed #28a745; color: #28a745; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-left-group">
            <a href="index.html " id="back-btn" class="btn btn-secondary" title="Voltar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </a>
            <span class="separator">|</span>
            <h1>Minigames</h1>
            <span class="separator">|</span>
            <h2 id="project-name"></h2>
            <span class="separator">|</span>
            <input type="text" id="search-input" placeholder="Pesquisar na tabela...">
        </div>
        <div class="header-actions">
            <div id="bulk-actions-container">
                <button id="delete-selected-btn" class="btn btn-danger">Excluir</button>
                <span class="separator">|</span>
            </div>
            <button id="show-add-item-modal-btn" class="btn btn-success">Adicionar Item</button>
            <span class="separator">|</span>
            <div class="file-input-wrapper">
                <button class="btn btn-secondary">Importar</button>
                <input type="file" id="import-json-input" accept=".json">
            </div>
            <button id="export-json-btn" class="btn btn-primary">Salvar</button>
        </div>
    </header>

    <div class="container">
        <div id="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 5%;" data-column="#">#</th>
                        <th style="width: 15%;" data-column="Nome">Nome</th>
                        <th style="width: 15%;" data-column="Inspiração">Inspiração</th>
                        <th style="width: 25%;" data-column="Descrição">Descrição</th>
                        <th style="width: 10%;" data-column="Local">Local</th>
                        <th style="width: 15%;" class="no-sort">Referências</th>
                        <th style="width: 15%;" class="no-sort">Curiosidades</th>
                        <th style="width: 5%; text-align: center;" class="no-sort"><input type="checkbox" id="select-all-checkbox" title="Selecionar Todos"></th>
                    </tr>
                </thead>
                <tbody id="minigames-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-item-modal" class="modal-overlay"></div>
    <div id="reference-modal" class="modal-overlay"></div>
    <div id="curiosity-modal" class="modal-overlay"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ⭐️ NOVO: Chama a função para aplicar o estilo global
    loadAndApplyGlobalStyle();

    let minigameData = [];
    let projectName = "Nenhum projeto carregado";
    let selectedItems = new Set();
    let currentSort = {};
    let initialDataState = '';
    
    const tableBody = document.getElementById('minigames-tbody');
    const searchInput = document.getElementById('search-input');
    
    const saveDataToLocalStorage = () => {
        try {
            const dataToSave = {
                projectName: projectName,
                games: minigameData
            };
            localStorage.setItem('minigameProjectData', JSON.stringify(dataToSave));
            initialDataState = JSON.stringify(minigameData);
        } catch (e) {
            console.error("Erro ao salvar dados no LocalStorage:", e);
            alert("Não foi possível salvar os dados. O armazenamento do navegador pode estar cheio.");
        }
    };

    const loadDataFromLocalStorage = () => {
        const savedData = localStorage.getItem('minigameProjectData');
        if (savedData) {
            try {
                const parsed = JSON.parse(savedData);
                minigameData = parsed.games || []; 
                projectName = parsed.projectName || "Projeto sem nome";
            } catch (e) {
                console.error("Falha ao carregar dados, começando do zero.", e);
                minigameData = [];
                projectName = "Erro ao carregar";
            }
        } else {
            minigameData = [];
            projectName = "Nenhum projeto carregado";
        }
        initialDataState = JSON.stringify(minigameData);
    };
    
    const hasUnsavedChanges = () => {
        const currentState = JSON.stringify(minigameData);
        return currentState !== initialDataState;
    };

    const updateHeader = () => { document.getElementById('project-name').textContent = projectName; };

    const renderTable = (dataToRender) => {
        tableBody.innerHTML = '';
        dataToRender.forEach((item) => {
            const originalIndex = minigameData.findIndex(originalItem => originalItem === item);
            if (originalIndex === -1) return;
            const row = document.createElement('tr');
            if (selectedItems.has(originalIndex)) row.classList.add('selected-row');
            const referencesHTML = (item['Referências'] || []).map((ref, i) => `<div class="reference-item"><a href="${ref.url || '#'}" target="_blank">${ref.nome || 'Link'}</a><span class="edit-pencil edit-ref-btn" data-item-index="${originalIndex}" data-ref-index="${i}">✏️</span></div>`).join('');
            const curiositiesHTML = (item['Curiosidades'] || []).map((cur, i) => `<div class="curiosity-item" data-item-index="${originalIndex}" data-curiosity-index="${i}">${cur.nome || 'Curiosidade'}</div>`).join('');
            row.innerHTML = `<td class="editable" data-index="${originalIndex}" data-key="#"><span class="cell-content">${item['#'] || ''}</span><span class="edit-pencil">✏️</span></td><td class="editable" data-index="${originalIndex}" data-key="Nome"><span class="cell-content">${item['Nome'] || ''}</span><span class="edit-pencil">✏️</span></td><td class="editable" data-index="${originalIndex}" data-key="Inspiração"><span class="cell-content">${item['Inspiração'] || ''}</span><span class="edit-pencil">✏️</span></td><td class="editable" data-index="${originalIndex}" data-key="Descrição"><span class="cell-content">${item['Descrição'] || ''}</span><span class="edit-pencil">✏️</span></td><td class="editable" data-index="${originalIndex}" data-key="Local"><span class="cell-content">${item['Local'] || ''}</span><span class="edit-pencil">✏️</span></td><td>${referencesHTML}<span class="add-btn add-ref-btn" data-item-index="${originalIndex}">+</span></td><td>${curiositiesHTML}<span class="add-btn add-curiosity-btn" data-item-index="${originalIndex}">+</span></td><td style="text-align: center;"><input type="checkbox" class="select-checkbox" data-index="${originalIndex}" ${selectedItems.has(originalIndex) ? 'checked' : ''}></td>`;
            tableBody.appendChild(row);
        });
    };
    
    const filterAndRender = () => {
        const filterText = searchInput.value.toLowerCase();
        const filteredData = filterText 
            ? minigameData.filter(item => Object.values(item).some(val => String(val).toLowerCase().includes(filterText)))
            : minigameData;
        renderTable(filteredData);
    };

    const updateBulkActionsVisibility = () => {
        document.getElementById('bulk-actions-container').classList.toggle('visible', selectedItems.size > 0);
    };

    const saveInlineEdit = (inputElement) => {
        const cell = inputElement.parentElement;
        const index = cell.dataset.index;
        const key = cell.dataset.key;
        let newValue = inputElement.value;
        if (index !== undefined && key && minigameData[index]) {
            if (key === '#') {
                newValue = newValue ? parseFloat(newValue) : null;
            }
            minigameData[index][key] = newValue;
            filterAndRender(); 
        } else {
           filterAndRender(); 
        }
    };

    // --- EVENT LISTENERS ---
    searchInput.addEventListener('keyup', filterAndRender);
    tableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('add-ref-btn')) openReferenceModal('add', e.target.dataset.itemIndex);
        if (e.target.classList.contains('edit-ref-btn')) openReferenceModal('edit', e.target.dataset.itemIndex, e.target.dataset.refIndex);
        if (e.target.classList.contains('add-curiosity-btn')) openCuriosityModal('add', e.target.dataset.itemIndex);
        if (e.target.classList.contains('curiosity-item')) openCuriosityModal('edit', e.target.dataset.itemIndex, e.target.dataset.curiosityIndex);
        if (e.target.classList.contains('select-checkbox')) {
            const index = parseInt(e.target.dataset.index, 10);
            if (e.target.checked) selectedItems.add(index); else selectedItems.delete(index);
            updateBulkActionsVisibility();
            e.target.closest('tr').classList.toggle('selected-row', e.target.checked);
        }
        const cell = e.target.closest('td.editable');
        if (cell && !cell.querySelector('input, textarea')) {
            const key = cell.dataset.key;
            const originalValue = minigameData[cell.dataset.index][key] || '';
            const inputType = key === 'Descrição' ? 'textarea' : (key === '#' ? 'number' : 'text');
            const inputElement = document.createElement(inputType === 'textarea' ? 'textarea' : 'input');
            if (inputType !== 'textarea') inputElement.type = inputType;
            if (inputType === 'number') inputElement.step = 'any';
            inputElement.className = 'inline-edit-input';
            inputElement.value = originalValue;
            cell.innerHTML = '';
            cell.appendChild(inputElement);
            inputElement.focus();
            inputElement.addEventListener('blur', () => saveInlineEdit(inputElement));
            inputElement.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && inputType !== 'textarea') inputElement.blur();
                else if (event.key === 'Escape') filterAndRender();
            });
        }
    });
    document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        selectedItems.clear();
        document.querySelectorAll('#minigames-tbody .select-checkbox').forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row.style.display !== 'none') {
                checkbox.checked = isChecked;
                const index = parseInt(checkbox.dataset.index, 10);
                if (isChecked) selectedItems.add(index);
                row.classList.toggle('selected-row', isChecked);
            }
        });
        updateBulkActionsVisibility();
    });
    document.getElementById('delete-selected-btn').addEventListener('click', () => {
        if (selectedItems.size === 0) return;
        if (confirm(`Tem certeza que deseja excluir ${selectedItems.size} item(ns) selecionado(s)?`)) {
            const sortedIndexes = Array.from(selectedItems).sort((a, b) => b - a);
            sortedIndexes.forEach(index => minigameData.splice(index, 1));
            selectedItems.clear();
            document.getElementById('select-all-checkbox').checked = false;
            updateBulkActionsVisibility();
            filterAndRender();
        }
    });

    // --- MODALS SETUP E LÓGICA ---
    const modals = {
        'add-item-modal': `<div class="modal-content"><span class="modal-close">×</span><h2>Adicionar Novo Item</h2><form id="add-item-form" class="form"><label for="modal-num">#:</label><input type="number" id="modal-num"><label for="modal-nome">Nome:</label><input type="text" id="modal-nome" required><label for="modal-inspiracao">Inspiração:</label><input type="text" id="modal-inspiracao"><label for="modal-descricao">Descrição:</label><textarea id="modal-descricao" rows="4"></textarea><label for="modal-local">Local:</label><input type="text" id="modal-local"><button type="submit" class="btn btn-success">Adicionar Item</button></form></div>`,
        'reference-modal': `<div class="modal-content"><span class="modal-close">×</span><h2 id="reference-modal-title">Adicionar Referência</h2><form id="reference-form" class="form"><input type="hidden" id="ref-item-index"><input type="hidden" id="ref-edit-index"><label for="ref-name">Nome:</label><input type="text" id="ref-name" required><label for="ref-url">URL:</label><input type="url" id="ref-url" required><button type="submit" class="btn btn-primary">Salvar Referência</button></form></div>`,
        'curiosity-modal': `<div class="modal-content"><span class="modal-close">×</span><h2 id="curiosity-modal-title">Adicionar Curiosidade</h2><form id="curiosity-form" class="form"><input type="hidden" id="cur-item-index"><input type="hidden" id="cur-edit-index"><label for="cur-name">Nome:</label><input type="text" id="cur-name" required><label for="cur-text">Curiosidade (Texto):</label><textarea id="cur-text" rows="4" maxlength="250"></textarea><div id="char-counter">0 / 250</div><label>Foto (636x450, JPG):</label><div id="curiosity-photo-container"><span id="curiosity-photo-placeholder">Clique para escolher uma imagem</span><img id="curiosity-photo-preview" src="" alt="Preview da curiosidade"></div><input type="file" id="cur-photo-input" accept="image/jpeg" style="display: none;"><div class="modal-footer"><button type="button" id="delete-curiosity-btn" class="btn btn-danger">Excluir</button><button type="submit" class="btn btn-primary">Salvar Curiosidade</button></div></form></div>`
    };
    for (const id in modals) document.getElementById(id).innerHTML = modals[id];
    document.getElementById('show-add-item-modal-btn').addEventListener('click', () => document.getElementById('add-item-modal').classList.add('visible'));
    document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', e => e.target.closest('.modal-overlay').classList.remove('visible')));
    document.querySelectorAll('.modal-overlay').forEach(modal => modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('visible'); }));
    document.getElementById('add-item-form').addEventListener('submit', e => {
        e.preventDefault();
        minigameData.push({'#': parseFloat(document.getElementById('modal-num').value) || null, 'Nome': document.getElementById('modal-nome').value, 'Inspiração': document.getElementById('modal-inspiracao').value, 'Descrição': document.getElementById('modal-descricao').value, 'Local': document.getElementById('modal-local').value, 'Referências': [], 'Curiosidades': [] });
        e.target.reset();
        filterAndRender();
        document.getElementById('add-item-modal').classList.remove('visible');
    });
    const referenceModal = document.getElementById('reference-modal');
    const openReferenceModal = (mode, itemIndex, refIndex = null) => {
        const form = document.getElementById('reference-form');
        form.reset();
        document.getElementById('ref-item-index').value = itemIndex;
        if (mode === 'edit' && refIndex !== null) {
            document.getElementById('reference-modal-title').textContent = 'Editar Referência';
            const ref = minigameData[itemIndex]['Referências'][refIndex];
            document.getElementById('ref-name').value = ref.nome; document.getElementById('ref-url').value = ref.url;
            document.getElementById('ref-edit-index').value = refIndex;
        } else {
            document.getElementById('reference-modal-title').textContent = 'Adicionar Referência';
            document.getElementById('ref-edit-index').value = '';
        }
        referenceModal.classList.add('visible');
    };
    document.getElementById('reference-form').addEventListener('submit', e => {
        e.preventDefault();
        const itemIndex = document.getElementById('ref-item-index').value, editIndex = document.getElementById('ref-edit-index').value;
        const newRef = { nome: document.getElementById('ref-name').value, url: document.getElementById('ref-url').value };
        if (editIndex) minigameData[itemIndex]['Referências'][editIndex] = newRef;
        else {
            if (!minigameData[itemIndex]['Referências']) minigameData[itemIndex]['Referências'] = [];
            minigameData[itemIndex]['Referências'].push(newRef);
        }
        filterAndRender();
        referenceModal.classList.remove('visible');
    });
    const curiosityModal = document.getElementById('curiosity-modal');
    const curPhotoInput = document.getElementById('cur-photo-input');
    const curPhotoContainer = document.getElementById('curiosity-photo-container');
    const curPhotoPreview = document.getElementById('curiosity-photo-preview');
    const curPhotoPlaceholder = document.getElementById('curiosity-photo-placeholder');
    const curTextarea = document.getElementById('cur-text');
    const charCounter = document.getElementById('char-counter');
    const openCuriosityModal = (mode, itemIndex, curiosityIndex = null) => {
        const form = document.getElementById('curiosity-form');
        form.reset();
        curPhotoPreview.src = '';
        curPhotoPreview.style.display = 'none';
        curPhotoPlaceholder.style.display = 'block';
        charCounter.textContent = '0 / 250';
        document.getElementById('cur-item-index').value = itemIndex;
        const deleteBtn = document.getElementById('delete-curiosity-btn');
        if (mode === 'edit' && curiosityIndex !== null) {
            document.getElementById('curiosity-modal-title').textContent = 'Editar Curiosidade';
            const curiosity = minigameData[itemIndex]['Curiosidades'][curiosityIndex];
            document.getElementById('cur-name').value = curiosity.nome;
            curTextarea.value = curiosity.texto;
            document.getElementById('cur-edit-index').value = curiosityIndex;
            if (curiosity.foto && curiosity.foto.startsWith('data:image')) {
                curPhotoPreview.src = curiosity.foto;
                curPhotoPreview.style.display = 'block';
                curPhotoPlaceholder.style.display = 'none';
            }
            deleteBtn.style.display = 'block';
        } else {
            document.getElementById('curiosity-modal-title').textContent = 'Adicionar Curiosidade';
            document.getElementById('cur-edit-index').value = '';
            deleteBtn.style.display = 'none';
        }
        curTextarea.dispatchEvent(new Event('input'));
        curiosityModal.classList.add('visible');
    };
    curPhotoContainer.addEventListener('click', () => curPhotoInput.click());
    curPhotoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type === 'image/jpeg') {
            const reader = new FileReader();
            reader.onload = (event) => {
                curPhotoPreview.src = event.target.result;
                curPhotoPreview.style.display = 'block';
                curPhotoPlaceholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        } else {
            alert('Por favor, selecione um arquivo de imagem .jpg');
            curPhotoInput.value = '';
        }
    });
    curTextarea.addEventListener('input', () => { charCounter.textContent = `${curTextarea.value.length} / 250`; });
    document.getElementById('curiosity-form').addEventListener('submit', e => {
        e.preventDefault();
        const itemIndex = document.getElementById('cur-item-index').value;
        const editIndex = document.getElementById('cur-edit-index').value;
        let currentPhoto = '';
        if (editIndex && minigameData[itemIndex]['Curiosidades'][editIndex]) {
            currentPhoto = minigameData[itemIndex]['Curiosidades'][editIndex].foto;
        }
        const newCuriosity = { nome: document.getElementById('cur-name').value, texto: document.getElementById('cur-text').value, foto: curPhotoPreview.src.startsWith('data:image') ? curPhotoPreview.src : currentPhoto };
        if (editIndex !== '') {
            minigameData[itemIndex]['Curiosidades'][editIndex] = newCuriosity;
        } else {
            if (!minigameData[itemIndex]['Curiosidades']) minigameData[itemIndex]['Curiosidades'] = [];
            minigameData[itemIndex]['Curiosidades'].push(newCuriosity);
        }
        filterAndRender();
        curiosityModal.classList.remove('visible');
    });
    document.getElementById('delete-curiosity-btn').addEventListener('click', () => {
        if (!confirm("Tem certeza que deseja excluir esta curiosidade?")) return;
        const itemIndex = document.getElementById('cur-item-index').value;
        const editIndex = document.getElementById('cur-edit-index').value;
        if (itemIndex && editIndex) {
            minigameData[itemIndex]['Curiosidades'].splice(editIndex, 1);
            filterAndRender();
            curiosityModal.classList.remove('visible');
        }
    });

    // --- IMPORT / EXPORT ---
    document.getElementById('export-json-btn').addEventListener('click', () => {
        if(minigameData.length === 0){
            alert("Não há dados para exportar. Adicione itens ou importe um arquivo primeiro.");
            return;
        }
        saveDataToLocalStorage();
        const dataStr = JSON.stringify(minigameData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${projectName.replace(/ /g, "_") || 'minigames'}.json`;
        a.click();
        URL.revokeObjectURL(url);
    });

    document.getElementById('import-json-input').addEventListener('change', (e) => {
        if (hasUnsavedChanges()) {
            if (!confirm("Você tem alterações não salvas. Deseja importar um novo projeto e perder as alterações atuais?")) {
                e.target.value = '';
                return;
            }
        }

        const file = e.target.files[0];
        if (!file) return;
        const nameToLoad = file.name.replace(/\.json$/i, '').replace(/_/g, ' ');
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (Array.isArray(importedData)) {
                    projectName = nameToLoad;
                    minigameData = importedData;
                    selectedItems.clear();
                    saveDataToLocalStorage();
                    updateHeader();
                    filterAndRender();
                    updateBulkActionsVisibility();
                    alert(`Projeto "${projectName}" importado com sucesso!`);
                } else {
                    alert('Erro: O arquivo JSON importado deve ser uma lista (array) de itens.');
                }
            } catch (err) { 
                alert('Falha ao importar: Arquivo JSON inválido.'); 
                console.error("Erro de importação:", err);
            }
        };
        reader.readAsText(file);
        e.target.value = '';
    });
    
    // --- ORDENAÇÃO ---
    document.querySelectorAll('thead th[data-column]').forEach(th => {
        th.addEventListener('click', () => {
            const columnKey = th.dataset.column;
            const isAsc = currentSort.column === columnKey && currentSort.direction === 'asc';
            currentSort = { column: columnKey, direction: isAsc ? 'desc' : 'asc' };
            minigameData.sort((a, b) => {
                let valA = a[columnKey], valB = b[columnKey];
                const isNumericSort = columnKey === '#';
                const hasValA = valA !== null && valA !== undefined && valA !== '';
                const hasValB = valB !== null && valB !== undefined && valB !== '';
                if (isNumericSort) {
                    if (hasValA && !hasValB) return -1;
                    if (!hasValA && hasValB) return 1;
                    return (valA || 0) - (valB || 0);
                } else {
                    return String(valA || '').toLowerCase().localeCompare(String(valB || '').toLowerCase());
                }
            });
            if (currentSort.direction === 'desc') minigameData.reverse();
            document.querySelectorAll('thead th[data-column]').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            filterAndRender();
        });
    });

    // --- EVENTOS DE SAÍDA DA PÁGINA ---
    document.getElementById('back-btn').addEventListener('click', (e) => {
        if (hasUnsavedChanges()) {
            if (!confirm("Você tem alterações não salvas. Deseja voltar e perder as alterações?")) {
                e.preventDefault(); 
            }
        }
    });

    window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges()) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    // ⭐️ INÍCIO DA SEÇÃO DE SCRIPT HERDADO ⭐️
    /**
     * Carrega os dados de estilo salvos em 'centralManagerData' no localStorage
     * e os aplica a esta página para manter a consistência visual.
     */
    function loadAndApplyGlobalStyle() {
        try {
            const savedData = localStorage.getItem('centralManagerData');
            if (!savedData) return;

            const appData = JSON.parse(savedData);
            if (!appData.styleData) return;
            
            const style = appData.styleData;
            const body = document.body;
            const root = document.documentElement;

            body.className = '';
            body.classList.add(style.theme || 'light-theme');

            body.style.backgroundColor = style.bgColor;

            root.style.setProperty('--bg-image', style.bgImage ? `url('${style.bgImage}')` : 'none');
            root.style.setProperty('--bg-opacity', style.bgOpacity || '1');

        } catch (e) {
            console.error("Não foi possível carregar ou aplicar o estilo global.", e);
        }
    }
    // ⭐️ FIM DA SEÇÃO DE SCRIPT HERDADO ⭐️

    // --- INICIALIZAÇÃO ---
    loadDataFromLocalStorage();
    updateHeader();
    filterAndRender();
});
</script>
</body>
</html>