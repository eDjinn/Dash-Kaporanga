<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Anotações</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* ⭐️ INÍCIO DA SEÇÃO DE ESTILO HERDADA ⭐️ */
        :root {
            --primary-text-color: #1a2533;
            --secondary-text-color: #6c757d;
            --page-bg-color: #f4f7f9;
            --card-bg-color: rgba(255, 255, 255, 0.92);
            --card-shadow-color: rgba(0, 0, 0, 0.1);
            --accent-color: #007bff;
            --bg-image: none;
            --bg-opacity: 1;
        }
        body.dark-theme {
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #b0b0b0;
            --page-bg-color: #121212;
            --card-bg-color: rgba(40, 40, 40, 0.92);
            --card-shadow-color: rgba(0, 0, 0, 0.4);
            --accent-color: #4dabf7;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--page-bg-color); 
            color: var(--primary-text-color); 
            margin: 0; padding: 0; position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1; background-image: var(--bg-image); background-size: cover;
            background-position: center; background-repeat: no-repeat;
            opacity: var(--bg-opacity); transition: opacity 0.3s ease, background-image 0.5s ease-in-out;
        }
        /* ⭐️ FIM DA SEÇÃO DE ESTILO HERDADA ⭐️ */

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        .main-header { 
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; 
            background-color: var(--card-bg-color); 
            box-shadow: 0 2px 4px var(--card-shadow-color);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            flex-wrap: wrap; gap: 15px;
        }
        .header-left-group, .header-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .main-header h1 { margin: 0; font-size: 1.5em; }
        .btn { padding: 8px 15px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; transition: background-color 0.2s; color: white; text-align: center; text-decoration: none; display: inline-flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .btn-success { background-color: #28a745; }
        .btn-primary { background-color: var(--accent-color); }
        .btn-secondary { background-color: #6c757d; }
        #back-btn { width: 40px; height: 40px; padding: 0; border-radius: 50%; }
        #back-btn svg { width: 22px; height: 22px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type]="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        #search-input { width: 200px; max-width: 250px; flex-grow: 1; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; background-color: var(--page-bg-color); color: var(--primary-text-color); }
        
        #primary-actions-container { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        
        #notes-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .note-card { background-color: var(--card-bg-color); border-radius: 8px; box-shadow: 0 4px 8px var(--card-shadow-color); padding: 15px; display: flex; flex-direction: column; gap: 10px; word-wrap: break-word; height: 250px; position: relative; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease; cursor: pointer; }
        .note-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px var(--card-shadow-color); }
        .note-card.sortable-ghost { opacity: 0.4; background: var(--accent-color); }
        .note-card.sortable-chosen { cursor: grabbing; }
        .note-card-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 5px; }
        body.dark-theme .note-card-header { border-color: #444; }
        .note-card-title { font-size: 1.2em; font-weight: bold; color: var(--accent-color); margin: 0; word-break: break-all; }
        .note-card-actions button { background: none; border: none; cursor: pointer; font-size: 1.1em; opacity: 0.6; transition: opacity 0.2s; padding: 2px; color: var(--secondary-text-color); }
        .note-card-actions button:hover { opacity: 1; }
        .note-card-content { flex-grow: 1; overflow-y: auto; white-space: pre-wrap; font-size: 0.95em; }
        .note-card-footer { margin-top: auto; padding-top: 8px; text-align: right; font-size: 0.8em; color: var(--secondary-text-color); border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        body.dark-theme .note-card-footer { border-color: #444; }
        .note-status { font-weight: bold; text-transform: capitalize; }
        
        .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: var(--card-bg-color); color: var(--primary-text-color); padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px var(--card-shadow-color); width: 90%; max-width: 500px; position: relative; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .form { display: flex; flex-direction: column; gap: 15px; flex-grow: 1; }
        .form-row { display: flex; gap: 15px; align-items: center; }
        .form-row > div { flex: 1; }
        .form label { font-weight: bold; margin-bottom: 5px; display: block; }
        .form input, .form textarea, .form select { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; font-size: 1em; background-color: var(--page-bg-color); color: var(--primary-text-color); }
        .form input[type="color"] { padding: 2px; height: 40px; }
        .form textarea { flex-grow: 1; resize: vertical; min-height: 150px; }
        .modal-footer { display: flex; justify-content: flex-end; margin-top: 15px; }

        .filter-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header-left-group { flex-grow: 1; }
            .header-scrolled #primary-actions-container { overflow: hidden; opacity: 0; max-height: 0; transition: max-height 0.4s ease-out, opacity 0.3s ease; }
            .note-card { height: 220px; }
            .filter-form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-left-group">
            <a href="index.html" id="back-btn" class="btn btn-secondary" title="Voltar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></a>
            <h1>Anotações</h1>
            <input type="text" id="search-input" placeholder="Pesquisar por texto...">
        </div>
        <div class="header-actions">
            <button id="add-note-btn" class="btn btn-success">Adicionar</button>
            <div id="primary-actions-container">
                <button id="filter-btn" class="btn btn-secondary">Filtro</button>
                <div class="file-input-wrapper"><button class="btn btn-secondary">Importar</button><input type="file" id="import-json-input" accept=".json"></div>
                <button id="export-json-btn" class="btn btn-primary">Exportar</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="notes-container"></div>
    </div>

    <div id="note-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">×</span>
            <h2 id="modal-title">Adicionar Anotação</h2>
            <form id="note-form" class="form">
                <input type="hidden" id="note-id">
                <div><label for="note-title">Título:</label><input type="text" id="note-title" required></div>
                <div><label for="note-content">Conteúdo:</label><textarea id="note-content" required></textarea></div>
                <div class="form-row">
                    <div><label for="note-status">Status:</label><select id="note-status"><option value="">Nenhum</option><option value="visto">Visto</option><option value="progresso">Em Progresso</option><option value="feito">Feito</option></select></div>
                    <div><label for="note-color">Cor do Card:</label><input type="color" id="note-color"></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary">Salvar Anotação</button></div>
            </form>
        </div>
    </div>

    <div id="filter-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">×</span>
            <h2>Filtrar Anotações</h2>
            <form id="filter-form" class="form">
                <div class="filter-form-grid">
                    <div><label for="start-date-filter">De:</label><input type="datetime-local" id="start-date-filter"></div>
                    <div><label for="end-date-filter">Até:</label><input type="datetime-local" id="end-date-filter"></div>
                    <div><label for="filter-status-select">Status:</label><select id="filter-status-select"><option value="all">Todos</option><option value="">Nenhum</option><option value="visto">Visto</option><option value="progresso">Em Progresso</option><option value="feito">Feito</option></select></div>
                    <div><label for="filter-color-input">Cor (hex):</label><input type="text" id="filter-color-input" placeholder="#ffffff"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="clear-filters-btn" class="btn btn-secondary">Limpar Filtros</button>
                    <button type="submit" class="btn btn-primary">Aplicar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const firebaseConfig = {
        apiKey: "AIzaSyC9OjBDOX9UUlCrPuhIZj5ipolRT4Gu420",
        authDomain: "gerenciadorcentral-f01e3.firebaseapp.com",
        projectId: "gerenciadorcentral-f01e3",
        storageBucket: "gerenciadorcentral-f01e3.appspot.com",
        messagingSenderId: "8874050225",
        appId: "1:8874050225:web:a536c7feb14f36af7cd890"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const notesDocRef = db.collection('settings').doc('notes-data');
    const styleDocRef = db.collection('settings').doc('main-dashboard');

    let notesData = [];
    let initialDataState = '[]';
    const defaultNoteColor = getComputedStyle(document.documentElement).getPropertyValue('--card-bg-color').trim();

    const saveDataToFirebase = () => {
        notesDocRef.set({ notes: notesData })
            .then(() => { initialDataState = JSON.stringify(notesData); })
            .catch(error => console.error("Erro ao salvar no Firebase:", error));
    };

    const loadDataFromFirebase = () => {
        notesDocRef.onSnapshot(doc => {
            notesData = (doc.exists && doc.data().notes) ? doc.data().notes : [];
            initialDataState = JSON.stringify(notesData);
            filterAndRender();
        }, error => console.error("Erro ao carregar dados do Firebase:", error));
    };
    
    async function loadAndApplyGlobalStyle() {
        try {
            const doc = await styleDocRef.get();
            if (doc.exists && doc.data().styleData) {
                const style = doc.data().styleData;
                const body = document.body, root = document.documentElement;
                body.className = ''; body.classList.add(style.theme || 'light-theme');
                body.style.backgroundColor = style.bgColor;
                root.style.setProperty('--bg-image', style.bgImage ? `url('${style.bgImage}')` : 'none');
                root.style.setProperty('--bg-opacity', style.bgOpacity || '1');
            }
        } catch (e) { console.error("Não foi possível carregar estilos do Firebase.", e); }
    }
    
    const notesContainer = document.getElementById('notes-container');
    const searchInput = document.getElementById('search-input');
    const noteModal = document.getElementById('note-modal');
    const noteForm = document.getElementById('note-form');
    const modalTitle = document.getElementById('modal-title');
    const filterModal = document.getElementById('filter-modal');
    const filterForm = document.getElementById('filter-form');
    
    const generateId = () => `note_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const formatTimestamp = (isoString) => isoString ? new Date(isoString).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : '';
    const hasUnsavedChanges = () => JSON.stringify(notesData) !== initialDataState;
    
    const updateContainerPadding = () => {
        const header = document.querySelector('.main-header');
        const container = document.querySelector('.container');
        if (header && container) container.style.paddingTop = `${header.offsetHeight + 20}px`;
    };

    const handleHeaderScroll = () => {
        document.querySelector('.main-header').classList.toggle('header-scrolled', window.scrollY > 10);
        updateContainerPadding();
    };

    const renderNotes = (dataToRender = notesData) => {
        notesContainer.innerHTML = (dataToRender.length === 0) ? `<p style="color: var(--secondary-text-color); padding: 20px; text-align: center;">Nenhuma anotação encontrada.</p>` : '';
        dataToRender.forEach(note => {
            const card = document.createElement('div');
            card.className = 'note-card';
            card.dataset.id = note.id;
            card.style.backgroundColor = note.color || '';
            const statusHTML = note.status ? `<span class="note-status">${note.status}</span>` : '';
            card.innerHTML = `<div class="note-card-header"><h3 class="note-card-title">${note.title}</h3><div class="note-card-actions"><button class="delete-btn" title="Excluir">🗑️</button></div></div><div class="note-card-content">${note.content}</div><footer class="note-card-footer">${statusHTML}<span>${formatTimestamp(note.timestamp)}</span></footer>`;
            notesContainer.appendChild(card);
        });
    };
    
    const filterAndRender = () => {
        const filterText = searchInput.value.toLowerCase();
        const startDate = document.getElementById('start-date-filter').value ? new Date(document.getElementById('start-date-filter').value).getTime() : null;
        const endDate = document.getElementById('end-date-filter').value ? new Date(document.getElementById('end-date-filter').value).getTime() : null;
        const filterStatus = document.getElementById('filter-status-select').value;
        const filterColor = document.getElementById('filter-color-input').value.trim().toLowerCase();

        let filteredData = notesData.filter(note => {
            const textMatch = (note.title || '').toLowerCase().includes(filterText) || (note.content || '').toLowerCase().includes(filterText);
            const noteTime = note.timestamp ? new Date(note.timestamp).getTime() : null;
            const dateMatch = (!startDate || (noteTime && noteTime >= startDate)) && (!endDate || (noteTime && noteTime <= endDate));
            const statusMatch = (filterStatus === 'all') || ((note.status || '') === filterStatus);
            const colorMatch = (!filterColor) || ((note.color || '').toLowerCase() === filterColor);

            return textMatch && dateMatch && statusMatch && colorMatch;
        });
        renderNotes(filteredData);
    };

    const openModal = (modalId, mode, noteId = null) => {
        const modal = document.getElementById(modalId);
        if (modalId === 'note-modal') {
            noteForm.reset(); 
            document.getElementById('note-id').value = '';
            modalTitle.textContent = 'Adicionar Anotação';
            document.getElementById('note-color').value = defaultNoteColor.startsWith('rgba') ? '#ffffff' : defaultNoteColor;

            if (mode === 'edit' && noteId) { 
                const note = notesData.find(n => n.id === noteId); 
                if (note) { 
                    modalTitle.textContent = 'Editar Anotação'; 
                    document.getElementById('note-id').value = note.id; 
                    document.getElementById('note-title').value = note.title; 
                    document.getElementById('note-content').value = note.content;
                    document.getElementById('note-status').value = note.status || '';
                    document.getElementById('note-color').value = note.color || (defaultNoteColor.startsWith('rgba') ? '#ffffff' : defaultNoteColor);
                } 
            }
        }
        modal.classList.add('visible');
    };

    const closeModal = (modalId) => document.getElementById(modalId).classList.remove('visible');

    const initSortable = () => {
        new Sortable(notesContainer, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            delay: 200,
            delayOnTouchOnly: true,
            onEnd: (evt) => {
                if (searchInput.value || document.getElementById('start-date-filter').value || document.getElementById('end-date-filter').value) {
                    alert("Limpe todos os filtros para poder reordenar as anotações.");
                    filterAndRender(); return;
                }
                const [movedItem] = notesData.splice(evt.oldIndex, 1);
                notesData.splice(evt.newIndex, 0, movedItem);
                saveDataToFirebase();
            }
        });
    };

    searchInput.addEventListener('input', filterAndRender);
    document.getElementById('add-note-btn').addEventListener('click', () => openModal('note-modal', 'add'));
    noteModal.querySelector('.modal-close').addEventListener('click', () => closeModal('note-modal'));

    noteForm.addEventListener('submit', e => {
        e.preventDefault();
        const id = document.getElementById('note-id').value;
        const data = {
            title: document.getElementById('note-title').value,
            content: document.getElementById('note-content').value,
            status: document.getElementById('note-status').value || null,
            color: document.getElementById('note-color').value,
            timestamp: new Date().toISOString()
        };

        if (id) {
            const noteIndex = notesData.findIndex(n => n.id === id);
            if (noteIndex > -1) {
                notesData[noteIndex] = { ...notesData[noteIndex], ...data };
            }
        } else {
            notesData.unshift({ ...data, id: generateId() });
        }
        closeModal('note-modal'); saveDataToFirebase();
    });

    notesContainer.addEventListener('click', e => {
        const card = e.target.closest('.note-card');
        if (!card) return;
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            e.stopPropagation();
            if (confirm('Tem certeza que deseja excluir esta anotação?')) {
                notesData = notesData.filter(n => n.id !== card.dataset.id);
                saveDataToFirebase();
            }
        } else {
            openModal('note-modal', 'edit', card.dataset.id);
        }
    });

    document.getElementById('filter-btn').addEventListener('click', () => openModal('filter-modal'));
    filterModal.querySelector('.modal-close').addEventListener('click', () => closeModal('filter-modal'));
    filterForm.addEventListener('submit', e => {
        e.preventDefault();
        filterAndRender();
        closeModal('filter-modal');
    });
    document.getElementById('clear-filters-btn').addEventListener('click', () => {
        filterForm.reset();
        filterAndRender();
        closeModal('filter-modal');
    });

    document.getElementById('export-json-btn').addEventListener('click', () => { 
        if(notesData.length === 0){ alert("Não há anotações para exportar."); return; } 
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({ notes: notesData }, null, 2)], { type: 'application/json' })); 
        a.download = `anotacoes_backup.json`; a.click(); URL.revokeObjectURL(a.href); 
    });
    document.getElementById('import-json-input').addEventListener('change', (e) => { 
        if (hasUnsavedChanges() && !confirm("Isto substituirá suas anotações. Deseja continuar?")) { e.target.value = ''; return; } 
        const file = e.target.files[0]; if (!file) return; 
        const reader = new FileReader(); 
        reader.onload = (event) => { 
            try { 
                const data = JSON.parse(event.target.result); 
                notesData = (Array.isArray(data)) ? data : (data && Array.isArray(data.notes)) ? data.notes : [];
                saveDataToFirebase(); alert(`Anotações importadas com sucesso!`); 
            } catch (err) { alert('Falha ao importar: Arquivo JSON inválido.'); } 
        }; 
        reader.readAsText(file); e.target.value = ''; 
    });
    
    document.getElementById('back-btn').addEventListener('click', (e) => { if (hasUnsavedChanges() && !confirm("Sair e perder alterações não salvas?")) e.preventDefault(); });
    window.addEventListener('beforeunload', (e) => { if (hasUnsavedChanges()) { e.preventDefault(); e.returnValue = ''; } });
    window.addEventListener('resize', updateContainerPadding);
    window.addEventListener('scroll', handleHeaderScroll);
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (noteModal.classList.contains('visible')) closeModal('note-modal');
            if (filterModal.classList.contains('visible')) closeModal('filter-modal');
        } else if (e.key === 'Enter' && e.ctrlKey) {
            if (noteModal.classList.contains('visible')) {
                e.preventDefault();
                noteForm.requestSubmit();
            }
        }
    });

    loadAndApplyGlobalStyle();
    loadDataFromFirebase();
    initSortable();
    updateContainerPadding();
});
</script>
</body>
</html>